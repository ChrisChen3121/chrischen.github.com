<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<!-- 2021-04-02 Fri 09:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>High Performance Python</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ChrisChen" />
<meta name="keywords" content="python, performance" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
	     margin-bottom: .2em; }
  .subtitle { text-align: center;
	      font-size: medium;
	      font-weight: bold;
	      margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
	    padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css">
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
	displayAlign: "left",
	displayIndent: "2em",

	"HTML-CSS": { scale: 100,
			linebreaks: { automatic: "false" },
			webFont: "TeX"
		       },
	SVG: {scale: 100,
	      linebreaks: { automatic: "false" },
	      font: "TeX"},
	NativeMML: {scale: 100},
	TeX: { equationNumbers: {autoNumber: "AMS"},
	       MultLineWidth: "85%",
	       TagSide: "left",
	       TagIndent: ".8em"
	     }
});
</script>
<script type="text/javascript"
	src="https://cdn.bootcdn.net/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">High Performance Python</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org11fad56">1. Hardware Resources</a>
<ul>
<li><a href="#orgae43743">1.1. Computing Unit</a></li>
<li><a href="#org3369d57">1.2. Memory Unit</a></li>
<li><a href="#org1cce73d">1.3. Communications Layers</a></li>
<li><a href="#org4097bc8">1.4. GPU</a></li>
<li><a href="#orgd27f24d">1.5. Performance Issues of Python</a></li>
</ul>
</li>
<li><a href="#orgb54233d">2. Profiling</a>
<ul>
<li><a href="#orgc133f7a">2.1. <code>timefn</code> decorator</a></li>
<li><a href="#orgf4c1e94">2.2. bulit-in <code>timeit</code> module</a></li>
<li><a href="#org0921827">2.3. CProfile</a></li>
<li><a href="#org3b58e09">2.4. <code>line_profiler</code></a></li>
<li><a href="#org8bdb3ef">2.5. <code>memory_profiler</code></a></li>
<li><a href="#org1f4666d">2.6. No-op @profile</a></li>
</ul>
</li>
<li><a href="#orgbbed6c3">3. Lists and tuples</a>
<ul>
<li><a href="#org68f77c0">3.1. Sort algorithm</a></li>
<li><a href="#org00fc171">3.2. list vs. tuple</a></li>
</ul>
</li>
<li><a href="#orgf9d99f1">4. set &amp; dict</a>
<ul>
<li><a href="#org2cf903f">4.1. hashable key</a></li>
<li><a href="#orgc429d75">4.2. resizing</a></li>
<li><a href="#org51db53d">4.3. extra</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org11fad56" class="outline-2">
<h2 id="org11fad56"><span class="section-number-2">1</span> Hardware Resources</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgae43743" class="outline-3">
<h3 id="orgae43743"><span class="section-number-3">1.1</span> Computing Unit</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The main properties of interest in a computing unit are the number of operations
it can do in one cycle and the number of cycles it can do in one second. The first
value is measured by its instructions per cycle(IPC), while the latter value is
measured by its clock speed.
</p>
<ul class="org-ul">
<li><b>SIMD</b>: Single instruction, multiple data. Efficient with high IPC. (CPU vectorization instruction)</li>
<li><b>Hyperthreading</b> presents a virtual second CPU to the host OS, and clever hardware logic tries</li>
</ul>
<p>
to interleave two threads of instructions into the execution units on a single CPU. When successful,
gains of up to 30% over a single thread can be achieved.
</p>
</div>
</div>

<div id="outline-container-org3369d57" class="outline-3">
<h3 id="org3369d57"><span class="section-number-3">1.2</span> Memory Unit</h3>
<div class="outline-text-3" id="text-1-2">
<p>
When trying to optimize the memory patterns of a program, we are simply optimizing
which data is placed where, how it is laid out (in order to increase the number of
sequential reads), and how many times it is moved among the various locations.
</p>
</div>
</div>

<div id="outline-container-org1cce73d" class="outline-3">
<h3 id="org1cce73d"><span class="section-number-3">1.3</span> Communications Layers</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>The <i>frontside</i> bus is the connection between the RAM and the L1/L2 cache</li>
<li>Two main properties of a bus:
<ul class="org-ul">
<li>how much data can be moved in one transfer (bus width)</li>
<li>how many transfers the bus can do per second (bus frequency).</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org4097bc8" class="outline-3">
<h3 id="org4097bc8"><span class="section-number-3">1.4</span> GPU</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>Drawbacks: Communicates through the PCI bus, which is much slower than the frontside bus</li>
</ul>
</div>
</div>

<div id="outline-container-orgd27f24d" class="outline-3">
<h3 id="orgd27f24d"><span class="section-number-3">1.5</span> Performance Issues of Python</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>Memory Fragmentation: due to garbage-collected</li>
<li>Dynamic Types: Using Cython to mitigate this problem</li>
<li>GIL: Using Cython or foreign functions</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgb54233d" class="outline-2">
<h2 id="orgb54233d"><span class="section-number-2">2</span> Profiling</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgc133f7a" class="outline-3">
<h3 id="orgc133f7a"><span class="section-number-3">2.1</span> <code>timefn</code> decorator</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timefn</span><span style="color: #3a81c3;">(</span>fn<span style="color: #3a81c3;">)</span>:
    <span style="color: #ba2f59; font-weight: bold;">@wraps</span><span style="color: #3a81c3;">(</span>fn<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">measure_time</span><span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">t1</span> = time.time<span style="color: #3a81c3;">()</span>
	<span style="color: #715ab1;">result</span> = fn<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">t2</span> = time.time<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>f<span style="color: #2d9574;">"@timefn: {fn.__name__} took {t2 - t1} seconds"</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> result
    <span style="color: #3a81c3; font-weight: bold;">return</span> measure_time
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf4c1e94" class="outline-3">
<h3 id="orgf4c1e94"><span class="section-number-3">2.2</span> bulit-in <code>timeit</code> module</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><a href="https://docs.python.org/3/library/timeit.html">Documentation</a></li>
<li>The <code>timeit</code> module temporarily disables the garbage collector.</li>
<li>More useful approach: IPython magic <code>%timeit</code></li>
</ul>
</div>
</div>

<div id="outline-container-org0921827" class="outline-3">
<h3 id="org0921827"><span class="section-number-3">2.3</span> CProfile</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre class="src src-sh">python -m cProfile -s cumulative test.py
python -m cProfile -o profile.stats test.py
</pre>
</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> pstats
<span style="color: #715ab1;">p</span> = pstats.Stats<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"profile.stats"</span><span style="color: #3a81c3;">)</span>
p.sort_stats<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"cumulative"</span><span style="color: #3a81c3;">)</span>
p.print_stats<span style="color: #3a81c3;">()</span>
p.print_callers<span style="color: #3a81c3;">()</span>
p.print_callees<span style="color: #3a81c3;">()</span>
</pre>
</div>
<ul class="org-ul">
<li><code>snakeviz</code> for visualization</li>
</ul>
</div>
</div>

<div id="outline-container-org3b58e09" class="outline-3">
<h3 id="org3b58e09"><span class="section-number-3">2.4</span> <code>line_profiler</code></h3>
<div class="outline-text-3" id="text-2-4">
<ol class="org-ol">
<li><code>pip install ~line_profiler~</code></li>
<li>Use <code>@profile</code> to mark the chosen function</li>
<li><code>kernprof -l -v test.py</code></li>
</ol>
</div>
</div>
<div id="outline-container-org8bdb3ef" class="outline-3">
<h3 id="org8bdb3ef"><span class="section-number-3">2.5</span> <code>memory_profiler</code></h3>
<div class="outline-text-3" id="text-2-5">
<ol class="org-ol">
<li><code>pip install psutil</code> (recommended)</li>
<li><code>pip install memory_profiler</code></li>
<li>Use <code>@profile</code> to mark the chosen function</li>
<li><code>python -m memory_profiler test.py</code></li>
</ol>
</div>
</div>

<div id="outline-container-org1f4666d" class="outline-3">
<h3 id="org1f4666d"><span class="section-number-3">2.6</span> No-op @profile</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Add it to the start of our module while unit testing
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">'line_profiler'</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">dir</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #2d9574;">'profile'</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">dir</span><span style="color: #3a81c3;">()</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">profile</span><span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> func
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgbbed6c3" class="outline-2">
<h2 id="orgbbed6c3"><span class="section-number-2">3</span> Lists and tuples</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org68f77c0" class="outline-3">
<h3 id="org68f77c0"><span class="section-number-3">3.1</span> Sort algorithm</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org5b73c53" class="outline-4">
<h4 id="org5b73c53"><span class="section-number-4">3.1.1</span> Tim sort</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
built-in sort algorithm
(it hybridizes insertion and merge sort algorithms).
</p>
</div>
</div>

<div id="outline-container-orgfa76599" class="outline-4">
<h4 id="orgfa76599"><span class="section-number-4">3.1.2</span> bisect</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
<b>bisect</b> provides support for maintaining a list in
sorted order without having to sort the list after each insertion.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> bisect
<span style="color: #715ab1;">alist</span>=<span style="color: #3a81c3;">[]</span>
bisect.insort<span style="color: #3a81c3;">(</span>alist, 5<span style="color: #3a81c3;">)</span>
bisect.insort<span style="color: #3a81c3;">(</span>alist, 3<span style="color: #3a81c3;">)</span>
bisect.insort<span style="color: #3a81c3;">(</span>alist, 20<span style="color: #3a81c3;">)</span>
bisect.insort<span style="color: #3a81c3;">(</span>alist, 17<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">print</span> alist
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; [3, 5, 17, 20]</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org00fc171" class="outline-3">
<h3 id="org00fc171"><span class="section-number-3">3.2</span> list vs. tuple</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org35c5f55" class="outline-4">
<h4 id="org35c5f55"><span class="section-number-4">3.2.1</span> list</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
dynamic arrays, mutable and allow for resizing.
</p>
</div>

<ul class="org-ul">
<li><a id="orgcb9638e"></a>resizing<br />
<div class="outline-text-5" id="text-orgcb9638e">
<p>
The growth pattern is:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">new size</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">5</td>
<td class="org-right">9</td>
<td class="org-right">17</td>
<td class="org-right">26</td>
<td class="org-right">36</td>
<td class="org-right">47</td>
<td class="org-left">&#x2026;</td>
</tr>

<tr>
<td class="org-left">new allocated</td>
<td class="org-right">0</td>
<td class="org-right">4</td>
<td class="org-right">8</td>
<td class="org-right">16</td>
<td class="org-right">25</td>
<td class="org-right">35</td>
<td class="org-right">46</td>
<td class="org-right">58</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
</table>
<div class="org-src-container">
<pre class="src src-c">new_allocated = <span style="color: #3a81c3;">(</span>newsize &gt;&gt; 3<span style="color: #3a81c3;">)</span> + <span style="color: #3a81c3;">(</span>newsize &lt; 9 ? 3 : 6<span style="color: #3a81c3;">)</span>;
new_allocated += newsize;
</pre>
</div>
</div>
</li>

<li><a id="org0824064"></a>dereference<br />
<div class="outline-text-5" id="text-org0824064">
<p>
List objects (for background, see Chapter 3) have an overhead for each dereference, as
the objects they reference can occur anywhere in memory.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgdfc3774" class="outline-4">
<h4 id="orgdfc3774"><span class="section-number-4">3.2.2</span> tuple</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
static arrays, immutable
</p>
<ul class="org-ul">
<li>instantiating a list can be 5.1x slower than instantiating a tuple</li>
<li>tuple is a hashable type</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf9d99f1" class="outline-2">
<h2 id="orgf9d99f1"><span class="section-number-2">4</span> set &amp; dict</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org2cf903f" class="outline-3">
<h3 id="org2cf903f"><span class="section-number-3">4.1</span> hashable key</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The type should implements both the <span class="underline"><span class="underline">hash</span></span> magic function and either <span class="underline"><span class="underline">eq</span></span> or <span class="underline"><span class="underline">cmp</span></span> .
</p>
</div>
<div id="outline-container-orgf3350ae" class="outline-4">
<h4 id="orgf3350ae"><span class="section-number-4">4.1.1</span> probing function</h4>
<div class="outline-text-4" id="text-4-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">pseudocode</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">mask is always equal to bin(hashtable_size - 1)</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">index_sequence</span><span style="color: #3a81c3;">(</span>key, mask=0b111, PERTURB_SHIFT=5<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">perturb</span> = <span style="color: #3a81c3;">hash</span><span style="color: #3a81c3;">(</span>key<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">i</span> = perturb &amp; mask
    <span style="color: #3a81c3; font-weight: bold;">yield</span> i
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
	<span style="color: #715ab1;">i</span> = <span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>i &lt;&lt; 2<span style="color: #6c3163;">)</span> + i + perturb + 1<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">perturb</span> &gt;&gt;= PERTURB_SHIFT
	<span style="color: #3a81c3; font-weight: bold;">yield</span> i &amp; mask
</pre>
</div>
</div>
</div>
<div id="outline-container-org0de2564" class="outline-4">
<h4 id="org0de2564"><span class="section-number-4">4.1.2</span> User-defined classes</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
User-defined classes have default hash and comparison functions.
The default <span class="underline"><span class="underline">hash</span></span> function simply returns the object’s placement
in memory as given by the built-in id function. Similarly,
the <span class="underline"><span class="underline">cmp</span></span> operator compares the numerical value of the object’s
placement in memory.
</p>
</div>
</div>

<div id="outline-container-org665569b" class="outline-4">
<h4 id="org665569b"><span class="section-number-4">4.1.3</span> entropy</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
“how well distributed my hash function is” is called the <b>entropy</b>
of the hash function:
\[S = - \sum_i p(i)\cdot\log(p(i))\]
</p>

<p>
where p(i) is the probability that the hash function gives hash i.
</p>

<p>
knowing up front what range of values will be used and how large
the dictionary will be helps in making a good selection.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc429d75" class="outline-3">
<h3 id="orgc429d75"><span class="section-number-3">4.2</span> resizing</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<ul class="org-ul">
<li><a id="orgbf9977a"></a>The growth pattern is:<br />
<div class="outline-text-5" id="text-orgbf9977a">
<p>
8, 32, 128, 512, 2048, 8192, 32768, 131072, 262144, &#x2026;
the number of bucket increases by 4x until we reach 50,000
elements, after which the size is increased by 2x.
</p>

<p>
resizing requires recomputing indices
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org51db53d" class="outline-3">
<h3 id="org51db53d"><span class="section-number-3">4.3</span> extra</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orgce18b4d" class="outline-4">
<h4 id="orgce18b4d"><span class="section-number-4">4.3.1</span> Namespace lookups</h4>
<div class="outline-text-4" id="text-4-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> math
<span style="color: #3a81c3; font-weight: bold;">from</span> math <span style="color: #3a81c3; font-weight: bold;">import</span> sin
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test1</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit test1(123456)</span>
<span style="color: #da8b55;">    1000000 loops, best of 3: 381 ns per loop</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> math.sin<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test2</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit test2(123456)</span>
<span style="color: #da8b55;">    1000000 loops, best of 3: 311 ns per loop</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> sin<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test3</span><span style="color: #3a81c3;">(</span>x, sin=math.sin<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit test3(123456)</span>
<span style="color: #da8b55;">    1000000 loops, best of 3: 306 ns per loop</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> sin<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-python">dis.dis<span style="color: #3a81c3;">(</span>test1<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">0 LOAD_GLOBAL      0 (math)  # Dictionary lookup</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3 LOAD_ATTR        1 (sin)   # Dictionary lookup</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">6 LOAD_FAST        0 (x)     # Local lookup</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">9 CALL_FUNCTION    1</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">12 RETURN_VALUE</span>

dis.dis<span style="color: #3a81c3;">(</span>test2<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">0 LOAD_GLOBAL      0 (sin)   # Dictionary lookup</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3 LOAD_FAST        0 (x)     # Local lookup</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">6 CALL_FUNCTION    1</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">9 RETURN_VALUE</span>

dis.dis<span style="color: #3a81c3;">(</span>test3<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">0 LOAD_FAST        1 (sin)   # Local lookup</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3 LOAD_FAST        0 (x)     # Local lookup</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">6 CALL_FUNCTION    1</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">9 RETURN_VALUE</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>

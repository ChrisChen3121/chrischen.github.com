<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<!-- 2020-06-09 Tue 16:23 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python Cookbook</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="chrischen" />
<meta name="keywords" content="python, cookbook" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../styles/demo/css/demo.css"/>
<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Python Cookbook</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgdcd44ae">1. Data Structures and Algorithms</a></li>
<li><a href="#org6962ddb">2. String Manipulation</a></li>
<li><a href="#org35ed0cf">3. Numbers</a></li>
<li><a href="#orgfbd19a7">4. Datetime</a></li>
<li><a href="#org8bcc3fa">5. Iterator</a></li>
<li><a href="#orgd70406f">6. I/O</a></li>
<li><a href="#org7f673ff">7. Encoding</a></li>
<li><a href="#orgddb6ec2">8. Functions</a></li>
<li><a href="#orgc9c0c44">9. Class</a></li>
<li><a href="#orgda93c8c">10. Metaprogramming</a></li>
<li><a href="#org06a29b2">11. Metaclass</a></li>
<li><a href="#org9294510">12. Packages and Modules</a></li>
<li><a href="#org3ed3cc5">13. Network</a></li>
<li><a href="#org0803a4c">14. Concurrency</a></li>
<li><a href="#org93a200a">15. System Utilities</a></li>
<li><a href="#org77ad752">16. Testing</a></li>
<li><a href="#orgcea03c7">17. Debuging</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgdcd44ae" class="outline-2">
<h2 id="orgdcd44ae"><span class="section-number-2">1</span> Data Structures and Algorithms</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org18b5b9b" class="outline-3">
<h3 id="org18b5b9b"><span class="section-number-3">1.1</span> Unpacking from Iterables</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-python">x, *<span style="color: #715ab1;">middle</span>, <span style="color: #715ab1;">y</span> = [1, 2, 3, 4, 5] <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">middle can be replaced by placeholder '_'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">x =&gt; 1</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">y =&gt; 5</span>

<span style="color: #715ab1;">data</span> = [<span style="color: #2d9574;">'ACME'</span>, 50, 91.1, (2012, 12, 21)]
name, shares, price, (year, mon, day) = data
</pre>
</div>
</div>
</div>

<div id="outline-container-org2aa2423" class="outline-3">
<h3 id="org2aa2423"><span class="section-number-3">1.2</span> Keeping the Last N Items</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> deque
<span style="color: #715ab1;">d</span>=deque(maxlen=N)
</pre>
</div>
</div>
</div>

<div id="outline-container-org8258ff4" class="outline-3">
<h3 id="org8258ff4"><span class="section-number-3">1.3</span> Finding the Largest N Items</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> heapq
heapq.nlargest(N, items)
heapq.nsmallest(N, items)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">heapq.nlargest(N, data, key=lambda function)</span>
</pre>
</div>
<p>
Underneath the covers, they work by first converting the data into a list
where items are ordered as a heap.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">nums</span> = [1, 8, 2, 23, 7, -4, 18, 23, 42, 37, 2]
heapq.heapify(nums) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">inplace function</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">nums =&gt; [-4, 2, 1, 23, 7, 2, 18, 23, 42, 37, 8] heap[0] is the smallest</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5a8f606" class="outline-3">
<h3 id="org5a8f606"><span class="section-number-3">1.4</span> PriorityQueue Implemention</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> heapq

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">PriorityQueue</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">self</span>._queue = []
        <span style="color: #3a81c3; font-weight: bold;">self</span>._index = 0 <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use index to properly order items with the same priori</span><span style="color: #6c4173; background-color: #ecf3ec;">ty level</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">push</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, item, priority):
        heapq.heappush(<span style="color: #3a81c3; font-weight: bold;">self</span>._queue, (-priority, <span style="color: #3a81c3; font-weight: bold;">self</span>._index, item))
        <span style="color: #3a81c3; font-weight: bold;">self</span>._index += 1

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">pop</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">return</span> heapq.heappop(<span style="color: #3a81c3; font-weight: bold;">self</span>._queue)[-1]
</pre>
</div>
</div>
</div>

<div id="outline-container-org2398a1b" class="outline-3">
<h3 id="org2398a1b"><span class="section-number-3">1.5</span> defaultdict</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> defaultdict
<span style="color: #715ab1;">d</span> = defaultdict(<span style="color: #3a81c3;">list</span>)
d[<span style="color: #2d9574;">'a'</span>]
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; []</span>
</pre>
</div>
<p>
<b>defaultdict</b> will automatically create dictionary entries for keys accessed later on, alternative:
</p>
<div class="org-src-container">
<pre class="src src-python">d.setdefault(<span style="color: #2d9574;">'a'</span>, []).append(1)
</pre>
</div>
</div>
<div id="outline-container-orgc9f1af8" class="outline-4">
<h4 id="orgc9f1af8"><span class="section-number-4">1.5.1</span> alternative</h4>
<div class="outline-text-4" id="text-1-5-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">d</span> = {}
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">A regular dictionary</span>
d.setdefault(<span style="color: #2d9574;">'a'</span>, []).append(1)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc704e34" class="outline-3">
<h3 id="orgc704e34"><span class="section-number-3">1.6</span> OrderedDict</h3>
<div class="outline-text-3" id="text-1-6">
<p>
An OrderedDict internally maintains a doubly linked list that orders the keys according to insertion order.
</p>
</div>
</div>

<div id="outline-container-orgd0a303a" class="outline-3">
<h3 id="orgd0a303a"><span class="section-number-3">1.7</span> sortedcontainers</h3>
<div class="outline-text-3" id="text-1-7">
<p>
SortedList, SortedDict, SortedSet
</p>
</div>
</div>

<div id="outline-container-org4de498b" class="outline-3">
<h3 id="org4de498b"><span class="section-number-3">1.8</span> Calculating with Dictionaries</h3>
<div class="outline-text-3" id="text-1-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">prices</span> = {
    <span style="color: #2d9574;">'ACME'</span>: 45.23,
    <span style="color: #2d9574;">'AAPL'</span>: 612.78,
    <span style="color: #2d9574;">'IBM'</span>: 205.55,
    <span style="color: #2d9574;">'HPQ'</span>: 37.20,
    <span style="color: #2d9574;">'FB'</span>: 10.75
}
<span style="color: #715ab1;">min_price</span> = <span style="color: #3a81c3;">min</span>(<span style="color: #3a81c3;">zip</span>(prices.values(), prices.keys())) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">zip to ((value, key)) gen</span><span style="color: #6c4173; background-color: #ecf3ec;">erator</span>

<span style="color: #3a81c3;">min</span>(prices, key=<span style="color: #3a81c3; font-weight: bold;">lambda</span> k: prices[k]) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns 'FB'</span>
<span style="color: #715ab1;">min_value</span> = prices[<span style="color: #3a81c3;">min</span>(prices, key=<span style="color: #3a81c3; font-weight: bold;">lambda</span> k: prices[k])]
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc59450e" class="outline-3">
<h3 id="orgc59450e"><span class="section-number-3">1.9</span> keys-view</h3>
<div class="outline-text-3" id="text-1-9">
<div class="org-src-container">
<pre class="src src-python">a.keys() &amp; b.keys()
a.keys() - {<span style="color: #2d9574;">'z'</span>, <span style="color: #2d9574;">'w'</span>} <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">{'z', 'w'} is a set</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org99446f0" class="outline-3">
<h3 id="org99446f0"><span class="section-number-3">1.10</span> Naming a Slice</h3>
<div class="outline-text-3" id="text-1-10">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">a</span> = [1,2,3,4,5]
<span style="color: #715ab1;">b</span> = <span style="color: #3a81c3;">slice</span>(1,2)

a[b] <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; [2] slower than a[1]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5669a1b" class="outline-3">
<h3 id="org5669a1b"><span class="section-number-3">1.11</span> Counting</h3>
<div class="outline-text-3" id="text-1-11">
<p>
  @contextmanager
def list_transaction(orig_list):
    working = list(orig_list)
    yield working
    orig_list[:] = working #+BEGIN_SRC python
     from collections import Counter
     word_counts1 = Counter(words1)
     word_counts2 = Counter(words2)
     word_counts1 + word_counts2
   #+END_SRC
</p>
</div>
</div>

<div id="outline-container-org25310d9" class="outline-3">
<h3 id="org25310d9"><span class="section-number-3">1.12</span> Sorting a List of Dictionaries</h3>
<div class="outline-text-3" id="text-1-12">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> operator <span style="color: #3a81c3; font-weight: bold;">import</span> itemgetter
<span style="color: #715ab1;">rows_by_fname</span> = <span style="color: #3a81c3;">sorted</span>(rows, key=itemgetter(<span style="color: #2d9574;">'fname'</span>))
<span style="color: #715ab1;">rows_by_lfname</span> = <span style="color: #3a81c3;">sorted</span>(rows, key=itemgetter(<span style="color: #2d9574;">'lname'</span>,<span style="color: #2d9574;">'fname'</span>))

<span style="color: #715ab1;">g</span> = itemgetter(2, 5, 3) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the call g(r) returns (r[2], r[5], r[3])</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgafbbd5d" class="outline-3">
<h3 id="orgafbbd5d"><span class="section-number-3">1.13</span> Sorting Objects Without Native Comparison</h3>
<div class="outline-text-3" id="text-1-13">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3;">sorted</span>(users, key=<span style="color: #3a81c3; font-weight: bold;">lambda</span> u: u.user_id)
<span style="color: #3a81c3; font-weight: bold;">from</span> operator <span style="color: #3a81c3; font-weight: bold;">import</span> attrgetter
<span style="color: #3a81c3;">sorted</span>(users, key=attrgetter(<span style="color: #2d9574;">'user_id'</span>))
<span style="color: #715ab1;">by_name</span> = <span style="color: #3a81c3;">sorted</span>(users, key=attrgetter(<span style="color: #2d9574;">'last_name'</span>, <span style="color: #2d9574;">'first_name'</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd4ae8b0" class="outline-3">
<h3 id="orgd4ae8b0"><span class="section-number-3">1.14</span> groupby</h3>
<div class="outline-text-3" id="text-1-14">
<p>
Since <code>groupby()</code> only examines consecutive items, should sort the groupby key first.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> itertools <span style="color: #3a81c3; font-weight: bold;">import</span> groupby
rows.sort(key=itemgetter(<span style="color: #2d9574;">'date'</span>))
<span style="color: #3a81c3; font-weight: bold;">for</span> date, items <span style="color: #3a81c3; font-weight: bold;">in</span> groupby(rows, key=itemgetter(<span style="color: #2d9574;">'date'</span>)):
    <span style="color: #3a81c3; font-weight: bold;">pass</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">alternative if memory is no concern, and faster than sort+groupby</span>
<span style="color: #715ab1;">rows_by_date</span> = defaultdict(<span style="color: #3a81c3;">list</span>)
<span style="color: #3a81c3; font-weight: bold;">for</span> row <span style="color: #3a81c3; font-weight: bold;">in</span> rows:
    rows_by_date[row[<span style="color: #2d9574;">'date'</span>]].append(row)
</pre>
</div>
</div>
</div>
<div id="outline-container-org0ca6b2d" class="outline-3">
<h3 id="org0ca6b2d"><span class="section-number-3">1.15</span> itertools.compress</h3>
<div class="outline-text-3" id="text-1-15">
<p>
Like boolean index in pandas. Takes an iterable and an accompanying Boolean selector sequence as input.
<code>list(compress(data, mask))</code>
</p>
</div>
</div>

<div id="outline-container-orge413ea2" class="outline-3">
<h3 id="orge413ea2"><span class="section-number-3">1.16</span> namedtuple &amp; namedlist</h3>
<div class="outline-text-3" id="text-1-16">
<p>
optional or missing fields
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">Stock</span> = namedtuple(<span style="color: #2d9574;">'Stock'</span>, [<span style="color: #2d9574;">'name'</span>, <span style="color: #2d9574;">'shares'</span>, <span style="color: #2d9574;">'price'</span>, <span style="color: #2d9574;">'date'</span>, <span style="color: #2d9574;">'time'</span>])
<span style="color: #715ab1;">Stock.__new__.__defaults__</span> = (<span style="color: #2d9574;">''</span>, 0, 0, <span style="color: #4e3163;">None</span>, <span style="color: #4e3163;">None</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">or</span>
<span style="color: #715ab1;">stock_prototype</span> = Stock(<span style="color: #2d9574;">''</span>, 0, 0.0, <span style="color: #4e3163;">None</span>, <span style="color: #4e3163;">None</span>)

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">dict_to_stock</span>(s):
    <span style="color: #3a81c3; font-weight: bold;">return</span> stock_prototype._replace(**s)
</pre>
</div>
</div>
<div id="outline-container-orgf77401d" class="outline-4">
<h4 id="orgf77401d"><span class="section-number-4">1.16.1</span> useful method</h4>
<div class="outline-text-4" id="text-1-16-1">
<ul class="org-ul">
<li><code>_make</code>: Make a new Stock object from a sequence or iterable</li>
<li><code>_replace</code></li>
<li><code>_fields</code></li>
<li><code>_asdict</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf89f515" class="outline-3">
<h3 id="orgf89f515"><span class="section-number-3">1.17</span> sum, min,&#x2026;</h3>
<div class="outline-text-3" id="text-1-17">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">s</span> = <span style="color: #3a81c3;">sum</span>((x * x <span style="color: #3a81c3; font-weight: bold;">for</span> x <span style="color: #3a81c3; font-weight: bold;">in</span> nums))
<span style="color: #715ab1;">s</span> = <span style="color: #3a81c3;">sum</span>(x * x <span style="color: #3a81c3; font-weight: bold;">for</span> x <span style="color: #3a81c3; font-weight: bold;">in</span> nums) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">same as above</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Original: Returns 20</span>
<span style="color: #715ab1;">min_shares</span> = <span style="color: #3a81c3;">min</span>(s[<span style="color: #2d9574;">'shares'</span>] <span style="color: #3a81c3; font-weight: bold;">for</span> s <span style="color: #3a81c3; font-weight: bold;">in</span> portfolio)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Alternative: Returns {'name': 'AOL', 'shares': 20}</span>
<span style="color: #715ab1;">min_shares</span> = <span style="color: #3a81c3;">min</span>(portfolio, key=<span style="color: #3a81c3; font-weight: bold;">lambda</span> s: s[<span style="color: #2d9574;">'shares'</span>])
</pre>
</div>
</div>
</div>

<div id="outline-container-org647fb73" class="outline-3">
<h3 id="org647fb73"><span class="section-number-3">1.18</span> ChainMap</h3>
<div class="outline-text-3" id="text-1-18">
<p>
A ChainMap takes multiple mappings and makes them logically appear as one. If there are duplicate keys,
the values from the first mapping get used.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> ChainMap
<span style="color: #715ab1;">c</span> = ChainMap(a,b)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">alternative</span>
<span style="color: #715ab1;">c</span> = b
c.update(a)
</pre>
</div>
<ul class="org-ul">
<li>but ChainMap keep the reference of a&amp;b</li>
</ul>
</div>

<div id="outline-container-org8015a7f" class="outline-4">
<h4 id="org8015a7f"><span class="section-number-4">1.18.1</span> store scoped values</h4>
<div class="outline-text-4" id="text-1-18-1">
<p>
A ChainMap is particularly useful when working with scoped values such as variables in
a programming language (i.e., globals, locals, etc.)
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">values</span> = ChainMap()
<span style="color: #715ab1;">values</span>[<span style="color: #2d9574;">'x'</span>] = 1
<span style="color: #715ab1;">values</span> = values.new_child()
<span style="color: #715ab1;">values</span>[<span style="color: #2d9574;">'x'</span>] = 2
values[<span style="color: #2d9574;">'x'</span>] <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 2</span>
<span style="color: #715ab1;">values</span> = values.parents
values[<span style="color: #2d9574;">'x'</span>] <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org6962ddb" class="outline-2">
<h2 id="org6962ddb"><span class="section-number-2">2</span> String Manipulation</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org55a5d1b" class="outline-3">
<h3 id="org55a5d1b"><span class="section-number-3">2.1</span> modules</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><b>fnmatch</b>: Filename matching with shell patterns.</li>
<li><b>glob</b>: Filename globbing utility.</li>
</ul>
</div>
</div>

<div id="outline-container-org88679b0" class="outline-3">
<h3 id="org88679b0"><span class="section-number-3">2.2</span> re</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org32bf2ab" class="outline-4">
<h4 id="org32bf2ab"><span class="section-number-4">2.2.1</span> find</h4>
<div class="outline-text-4" id="text-2-2-1">
<ul class="org-ul">
<li><code>match()</code></li>
<li><code>findall()</code></li>
<li><code>finditer()</code></li>
<li><code>scaner()</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgc120eb6" class="outline-4">
<h4 id="orgc120eb6"><span class="section-number-4">2.2.2</span> replace</h4>
<div class="outline-text-4" id="text-2-2-2">
<ul class="org-ul">
<li><code>sub</code></li>
</ul>
</div>
</div>

<div id="outline-container-orge4df9c9" class="outline-4">
<h4 id="orge4df9c9"><span class="section-number-4">2.2.3</span> regex</h4>
<div class="outline-text-4" id="text-2-2-3">
<ul class="org-ul">
<li>named capture group: <code>r'?P&lt;TOKENNAME&gt;[a-zA-Z]+'</code></li>
<li>noncapture</li>
</ul>
</div>
</div>

<div id="outline-container-orge6b56f5" class="outline-4">
<h4 id="orge6b56f5"><span class="section-number-4">2.2.4</span> tokenize</h4>
<div class="outline-text-4" id="text-2-2-4">
</div>
<ul class="org-ul">
<li><a id="org4fea775"></a>Problem<br />
<div class="outline-text-5" id="text-org4fea775">
<p>
You have a string that you want to parse left to right into a stream of tokens.
</p>
</div>
</li>
<li><a id="org9c1c22d"></a>Usage<br />
<div class="outline-text-5" id="text-org9c1c22d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> namedtuple
<span style="color: #715ab1;">Token</span> = namedtuple(<span style="color: #2d9574;">'Token'</span>, [<span style="color: #2d9574;">'type'</span>, <span style="color: #2d9574;">'value'</span>])


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">generate_tokens</span>(pat, text):
    <span style="color: #715ab1;">scanner</span> = pat.scanner(text)
    <span style="color: #3a81c3; font-weight: bold;">for</span> m <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">iter</span>(scanner.match, <span style="color: #4e3163;">None</span>):
        <span style="color: #3a81c3; font-weight: bold;">yield</span> Token(m.lastgroup, m.group())


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example use</span>
<span style="color: #3a81c3; font-weight: bold;">for</span> tok <span style="color: #3a81c3; font-weight: bold;">in</span> generate_tokens(master_pat, <span style="color: #2d9574;">'foo = 42'</span>):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(tok)

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Produces output</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='NAME', value='foo')</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='WS', value=' ')</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='EQ', value='=')</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='WS', value=' ')</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='NUM', value='42')</span>
</pre>
</div>
<p>
<code>scanner()</code> method of pattern objects. This method creates a scanner object in which repeated calls to match() step through the
supplied text one match at a time
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org6aea4f3" class="outline-4">
<h4 id="org6aea4f3"><span class="section-number-4">2.2.5</span> syntax parser</h4>
<div class="outline-text-4" id="text-2-2-5">
<ul class="org-ul">
<li>PyParsing</li>
<li>PLY</li>
<li>Recipe: 2.19</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgfdd20d6" class="outline-3">
<h3 id="orgfdd20d6"><span class="section-number-3">2.3</span> format</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-org5c02897" class="outline-4">
<h4 id="org5c02897"><span class="section-number-4">2.3.1</span> align</h4>
<div class="outline-text-4" id="text-2-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3;">format</span>(<span style="color: #2d9574;">'right'</span>, <span style="color: #2d9574;">'&gt;20'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">'               right'</span>
<span style="color: #3a81c3;">format</span>(<span style="color: #2d9574;">'right'</span>, <span style="color: #2d9574;">'=&gt;20'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">'===============right'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgea9e66c" class="outline-4">
<h4 id="orgea9e66c"><span class="section-number-4">2.3.2</span> safesub</h4>
<div class="outline-text-4" id="text-2-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">safesub</span>(<span style="color: #3a81c3;">dict</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__missing__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, key):
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">'{'</span> + key + <span style="color: #2d9574;">'}'</span>

<span style="color: #715ab1;">name</span> = <span style="color: #2d9574;">'ABC'</span>
<span style="color: #715ab1;">n</span> = 5
<span style="color: #715ab1;">s</span> = <span style="color: #2d9574;">'{name} has {n} messages.'</span>
s.format_map(safesub(<span style="color: #3a81c3;">vars</span>()))
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">'ABC has 5 messages.'</span>
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="orga2e2703"></a>frame hack<br />
<div class="outline-text-5" id="text-orga2e2703">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">sub</span>(text):
    <span style="color: #3a81c3; font-weight: bold;">return</span> text.format_map(safesub(sys._getframe(1).f_locals))
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org2d7b7c3" class="outline-4">
<h4 id="org2d7b7c3"><span class="section-number-4">2.3.3</span> textwrap</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
The textwrap module is a straightforward way to clean up text for printing.
<code>textwrap.fill()</code> reformat text for output.
</p>
</div>
</div>
</div>

<div id="outline-container-org7e14860" class="outline-3">
<h3 id="org7e14860"><span class="section-number-3">2.4</span> join</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li><code>'abc' + ',' + 'def'</code></li>
<li><code>'abc' ',' 'def'</code></li>
<li><code>','.join(('abc', 'def'))</code></li>
<li><code>'{},{}'.format('abc', 'def')</code></li>
<li>print('abc', 'def', sep=',')</li>
</ul>
</div>
</div>

<div id="outline-container-org7285d34" class="outline-3">
<h3 id="org7285d34"><span class="section-number-3">2.5</span> Combining I/O Write Operation</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">combine</span>(source, maxsize):
    <span style="color: #715ab1;">parts</span> = []
    <span style="color: #715ab1;">size</span> = 0
    <span style="color: #3a81c3; font-weight: bold;">for</span> part <span style="color: #3a81c3; font-weight: bold;">in</span> source:
        parts.append(part)
        <span style="color: #715ab1;">size</span> += <span style="color: #3a81c3;">len</span>(part)
        <span style="color: #3a81c3; font-weight: bold;">if</span> size &gt; maxsize:
            <span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #2d9574;">''</span>.join(parts)
            <span style="color: #715ab1;">parts</span> = []
            <span style="color: #715ab1;">size</span> = 0
    <span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #2d9574;">''</span>.join(parts)

<span style="color: #3a81c3; font-weight: bold;">for</span> part <span style="color: #3a81c3; font-weight: bold;">in</span> combine(sample(), 32768):
    f.write(part)
</pre>
</div>
<ul class="org-ul">
<li>Example: write to socket send buffer</li>
</ul>
</div>
</div>

<div id="outline-container-orge414bf3" class="outline-3">
<h3 id="orge414bf3"><span class="section-number-3">2.6</span> escape</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li><code>html.escape</code></li>
<li><code>xml.escape</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgc6ffe44" class="outline-3">
<h3 id="orgc6ffe44"><span class="section-number-3">2.7</span> Tokenizing Text</h3>
<div class="outline-text-3" id="text-2-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> re
<span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> namedtuple

<span style="color: #715ab1;">NAME</span> = r<span style="color: #2d9574;">'(?P&lt;NAME&gt;[a-zA-Z_][a-zA-Z_0-9]*)'</span>
<span style="color: #715ab1;">NUM</span> = r<span style="color: #2d9574;">'(?P&lt;NUM&gt;\d+)'</span>
<span style="color: #715ab1;">PLUS</span> = r<span style="color: #2d9574;">'(?P&lt;PLUS&gt;\+)'</span>
<span style="color: #715ab1;">TIMES</span> = r<span style="color: #2d9574;">'(?P&lt;TIMES&gt;\*)'</span>
<span style="color: #715ab1;">EQ</span> = r<span style="color: #2d9574;">'(?P&lt;EQ&gt;=)'</span>
<span style="color: #715ab1;">WS</span> = r<span style="color: #2d9574;">'(?P&lt;WS&gt;\s+)'</span>

<span style="color: #715ab1;">master_pat</span> = re.<span style="color: #3a81c3;">compile</span>(<span style="color: #2d9574;">'|'</span>.join([NAME, NUM, PLUS, TIMES, EQ, WS]))

<span style="color: #715ab1;">Token</span> = namedtuple(<span style="color: #2d9574;">'Token'</span>, [<span style="color: #2d9574;">'type'</span>, <span style="color: #2d9574;">'value'</span>])


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">generate_tokens</span>(pat, text):
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">scanner method creates a scanner object in which repeated calls to match()</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">step through the supplied text one match at a time</span>
    <span style="color: #715ab1;">scanner</span> = pat.scanner(text)
    <span style="color: #3a81c3; font-weight: bold;">for</span> m <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">iter</span>(scanner.match, <span style="color: #4e3163;">None</span>):
        <span style="color: #3a81c3; font-weight: bold;">yield</span> Token(m.lastgroup, m.group())


<span style="color: #715ab1;">tokens</span> = (tok <span style="color: #3a81c3; font-weight: bold;">for</span> tok <span style="color: #3a81c3; font-weight: bold;">in</span> generate_tokens(master_pat, <span style="color: #2d9574;">'foo = 42'</span>)
          <span style="color: #3a81c3; font-weight: bold;">if</span> tok.<span style="color: #3a81c3;">type</span> != <span style="color: #2d9574;">'WS'</span>)
<span style="color: #3a81c3; font-weight: bold;">for</span> tok <span style="color: #3a81c3; font-weight: bold;">in</span> tokens:
    <span style="color: #3a81c3; font-weight: bold;">print</span>(tok)

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Produces output</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='NAME', value='foo')</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='EQ', value='=')</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Token(type='NUM', value='42')</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org35ed0cf" class="outline-2">
<h2 id="org35ed0cf"><span class="section-number-2">3</span> Numbers</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orge6bdc2d" class="outline-3">
<h3 id="orge6bdc2d"><span class="section-number-3">3.1</span> round</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3;">round</span>(1.29, 1)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1.3</span>
<span style="color: #3a81c3;">round</span>(1245, -1)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1240</span>
<span style="color: #3a81c3;">round</span>(1275, -1)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1280</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbbdd57a" class="outline-3">
<h3 id="orgbbdd57a"><span class="section-number-3">3.2</span> Decimal</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> decimal <span style="color: #3a81c3; font-weight: bold;">import</span> Decimal, localcontext
<span style="color: #715ab1;">a</span> = Decimal(<span style="color: #2d9574;">'6.32'</span>)
<span style="color: #715ab1;">b</span> = Decimal(<span style="color: #2d9574;">'2.41'</span>)

<span style="color: #3a81c3; font-weight: bold;">with</span> localcontext() <span style="color: #3a81c3; font-weight: bold;">as</span> ctx:
    <span style="color: #715ab1;">ctx.prec</span> = 5
    <span style="color: #3a81c3; font-weight: bold;">print</span>(a/b) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">2.6224</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c18e80" class="outline-3">
<h3 id="org7c18e80"><span class="section-number-3">3.3</span> Formatting</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">x</span> = 1234.56789
<span style="color: #3a81c3;">format</span>(x, <span style="color: #2d9574;">'0.2f'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '1234.57'   # round</span>
<span style="color: #3a81c3;">format</span>(x, <span style="color: #2d9574;">'&gt;10.1f'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '    1234.6'</span>
<span style="color: #3a81c3;">format</span>(x, <span style="color: #2d9574;">'0,.1f'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '1,234.6</span>

<span style="color: #715ab1;">x</span> = 1234
<span style="color: #3a81c3;">bin</span>(x)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">others: oct, hex</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '0b10011010010'</span>
<span style="color: #3a81c3;">format</span>(x, <span style="color: #2d9574;">'b'</span>)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">others: o, x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '0011010010'</span>
<span style="color: #3a81c3;">int</span>(<span style="color: #2d9574;">'10011010010'</span>, 2)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1234</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org805918b" class="outline-3">
<h3 id="org805918b"><span class="section-number-3">3.4</span> Bin, Oct, Hex Int</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">x</span> = -1234
<span style="color: #3a81c3;">format</span>(x, <span style="color: #2d9574;">'b'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '-10011010010'</span>
<span style="color: #3a81c3;">format</span>(x, <span style="color: #2d9574;">'x'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '-4d2'</span>
<span style="color: #3a81c3;">format</span>(2**32 + x, <span style="color: #2d9574;">'b'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '11111111111111111111101100101110'</span>
<span style="color: #3a81c3;">format</span>(2**32 + x, <span style="color: #2d9574;">'x'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 'fffffb2e'</span>
<span style="color: #3a81c3;">int</span>(<span style="color: #2d9574;">'4d2'</span>, 16)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1234</span>
<span style="color: #3a81c3;">int</span>(<span style="color: #2d9574;">'10011010010'</span>, 2)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1234</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb0bb61e" class="outline-3">
<h3 id="orgb0bb61e"><span class="section-number-3">3.5</span> Bytes2Int</h3>
<div class="outline-text-3" id="text-3-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">data</span> = b<span style="color: #2d9574;">'\x00\x124V\x00x\x90\xab\x00\xcd\xef\x01\x00#\x004'</span>
<span style="color: #715ab1;">x</span> = <span style="color: #3a81c3;">int</span>.from_bytes(data, <span style="color: #2d9574;">'little'</span>)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">or 'big</span>

<span style="color: #715ab1;">x</span> = 94522842520747284487117727783387188
x.to_bytes(16, <span style="color: #2d9574;">'little'</span>)
</pre>
</div>
<p>
useful in cryptography or networking domains
</p>
<ul class="org-ul">
<li><code>struct</code> module</li>
<li><code>int.bit_length()</code></li>
</ul>
</div>
</div>

<div id="outline-container-org5e7d392" class="outline-3">
<h3 id="org5e7d392"><span class="section-number-3">3.6</span> Complex Math</h3>
<div class="outline-text-3" id="text-3-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">a</span> = <span style="color: #3a81c3;">complex</span>(2, 4)
<span style="color: #715ab1;">b</span> = 3 - 5j
a.conjugate()
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (2-4j)</span>
<span style="color: #3a81c3;">abs</span>(a)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 4.47213595499958</span>
a * b
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (26+2j)</span>

<span style="color: #3a81c3; font-weight: bold;">import</span> cmath
cmath.sin(a)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (24.83130584894638-11.356612711218174j)</span>

<span style="color: #3a81c3; font-weight: bold;">import</span> numpy <span style="color: #3a81c3; font-weight: bold;">as</span> np
<span style="color: #715ab1;">a</span> = np.array([2 + 3j, 4 + 5j, 6 - 7j, 8 + 9j])
np.sin(a)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd21c7a7" class="outline-3">
<h3 id="orgd21c7a7"><span class="section-number-3">3.7</span> random</h3>
<div class="outline-text-3" id="text-3-7">
<ul class="org-ul">
<li><code>random.choice</code></li>
<li><code>random.sample</code></li>
<li><code>random.shuffle</code></li>
<li><code>random.randint</code></li>
<li><code>random.random</code>: 0 to 1</li>
<li><code>random.getrandbits</code></li>
</ul>
</div>
<div id="outline-container-org580450a" class="outline-4">
<h4 id="org580450a"><span class="section-number-4">3.7.1</span> seed</h4>
<div class="outline-text-4" id="text-3-7-1">
<div class="org-src-container">
<pre class="src src-python">random.seed()  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Seed based on system time or os.urandom()</span>
random.seed(12345)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Seed based on integer given</span>
random.seed(b<span style="color: #2d9574;">'bytedata'</span>)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Seed based on byte data</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4b4690" class="outline-4">
<h4 id="orgb4b4690"><span class="section-number-4">3.7.2</span> distribution</h4>
<div class="outline-text-4" id="text-3-7-2">
<ul class="org-ul">
<li><code>random.uniform</code></li>
<li><code>random.gauss</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgec16026" class="outline-3">
<h3 id="orgec16026"><span class="section-number-3">3.8</span> math.f***</h3>
<div class="outline-text-3" id="text-3-8">
<ul class="org-ul">
<li><code>math.fsum</code></li>
<li><code>math.fmod</code></li>
<li><code>math.fabs</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgfbd19a7" class="outline-2">
<h2 id="orgfbd19a7"><span class="section-number-2">4</span> Datetime</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org2e8efa7" class="outline-3">
<h3 id="org2e8efa7"><span class="section-number-3">4.1</span> Finding Last Friday</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> dateutil.relativedelta <span style="color: #3a81c3; font-weight: bold;">import</span> relativedelta
<span style="color: #3a81c3; font-weight: bold;">from</span> dateutil.rrule <span style="color: #3a81c3; font-weight: bold;">import</span> FR
<span style="color: #715ab1;">d</span> = datetime.now()
<span style="color: #3a81c3; font-weight: bold;">print</span>(d + relativedelta(weekday=FR(-1)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgee544e8" class="outline-3">
<h3 id="orgee544e8"><span class="section-number-3">4.2</span> Timezone</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> pytz
<span style="color: #715ab1;">d</span> = datetime.now() <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">no timezone info</span>
<span style="color: #3a81c3; font-weight: bold;">print</span>(d)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 2018-12-21 17:14:01.258941</span>

<span style="color: #715ab1;">shanghai</span> = pytz.timezone(<span style="color: #2d9574;">'Asia/Shanghai'</span>)
<span style="color: #715ab1;">loc_d</span> = shanghai.localize(d) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Localize the date for Shanghai</span>
<span style="color: #3a81c3; font-weight: bold;">print</span>(loc_d)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 2018-12-21 17:14:01.258941+08:00</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Once the date has been localized, it can be converted to other time zones</span>
<span style="color: #715ab1;">utc_d</span> = loc_d.astimezone(pytz.utc)
<span style="color: #3a81c3; font-weight: bold;">print</span>(utc_d)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 2018-12-21 09:14:01.258941+00:00</span>
</pre>
</div>

<ul class="org-ul">
<li><code>datetime.replace</code></li>
<li><code>datetime.astimezone</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org8bcc3fa" class="outline-2">
<h2 id="org8bcc3fa"><span class="section-number-2">5</span> Iterator</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org4faa76e" class="outline-3">
<h3 id="org4faa76e"><span class="section-number-3">5.1</span> Manually Consuming an Iterator</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">iterable</span> = <span style="color: #3a81c3;">iter</span>(<span style="color: #3a81c3;">range</span>(5))  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Invokes range.__iter__()</span>
<span style="color: #3a81c3; font-weight: bold;">try</span>:
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
        <span style="color: #715ab1;">line</span> = <span style="color: #3a81c3;">next</span>(iterable)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Invokes iterable.__next__()</span>
        <span style="color: #3a81c3; font-weight: bold;">print</span>(line, end=<span style="color: #2d9574;">''</span>)
<span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">non exception version</span>
<span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
    <span style="color: #715ab1;">line</span> = <span style="color: #3a81c3;">next</span>(iterable, <span style="color: #4e3163;">None</span>)
    <span style="color: #3a81c3; font-weight: bold;">if</span> line <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
        <span style="color: #3a81c3; font-weight: bold;">break</span>
    <span style="color: #3a81c3; font-weight: bold;">print</span>(line, end=<span style="color: #2d9574;">''</span>)
</pre>
</div>
<ul class="org-ul">
<li>Python’s iterator protocol requires <code>__iter__()</code> to return a special iterator object that implements a <code>__next__()</code> method to carry out the actual iteration.</li>
</ul>
</div>
</div>
<div id="outline-container-orge5dc642" class="outline-3">
<h3 id="orge5dc642"><span class="section-number-3">5.2</span> Iterating Over Multi Sequences</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">a</span> = [1, 2, 3]
<span style="color: #715ab1;">b</span> = [<span style="color: #2d9574;">'w'</span>, <span style="color: #2d9574;">'x'</span>, <span style="color: #2d9574;">'y'</span>, <span style="color: #2d9574;">'z'</span>]

<span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">zip</span>(a, b):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(i)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (1, 'w') (2, 'x') (3, 'y')</span>

<span style="color: #3a81c3; font-weight: bold;">from</span> itertools <span style="color: #3a81c3; font-weight: bold;">import</span> zip_longest
<span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> zip_longest(a, b):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(i)
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (1, 'w') (2, 'x') (3, 'y') (None, 'z')</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge4660f1" class="outline-3">
<h3 id="orge4660f1"><span class="section-number-3">5.3</span> <code>dropwhile</code></h3>
<div class="outline-text-3" id="text-5-3">
<p>
Drop all of the initial comment lines.
</p>
</div>
</div>

<div id="outline-container-orgdbcad73" class="outline-3">
<h3 id="orgdbcad73"><span class="section-number-3">5.4</span> Permutation &amp; Combination</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li><code>combinations</code>, <code>permutations</code>, <code>combinations_with_replacement</code></li>
</ul>
</div>
</div>

<div id="outline-container-org81e6163" class="outline-3">
<h3 id="org81e6163"><span class="section-number-3">5.5</span> <code>itertools.chain</code></h3>
<div class="outline-text-3" id="text-5-5">
<p>
Concatenate two iterables(copy-free)
</p>
</div>
</div>
<div id="outline-container-org848c251" class="outline-3">
<h3 id="org848c251"><span class="section-number-3">5.6</span> Data Processing Pipelines</h3>
</div>
<div id="outline-container-orgd69a8cc" class="outline-3">
<h3 id="orgd69a8cc"><span class="section-number-3">5.7</span> Flattening a Nested Sequence</h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> Iterable


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">flatten</span>(items, ignore_types=(<span style="color: #3a81c3;">str</span>, <span style="color: #3a81c3;">bytes</span>)):
    <span style="color: #3a81c3; font-weight: bold;">for</span> x <span style="color: #3a81c3; font-weight: bold;">in</span> items:
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span>(x, Iterable) <span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span>(x, ignore_types):
            <span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #3a81c3; font-weight: bold;">from</span> flatten(x)
        <span style="color: #3a81c3; font-weight: bold;">else</span>:
            <span style="color: #3a81c3; font-weight: bold;">yield</span> x

<span style="color: #715ab1;">items</span> = [<span style="color: #2d9574;">'Dave'</span>, <span style="color: #2d9574;">'Paula'</span>, [<span style="color: #2d9574;">'Thomas'</span>, <span style="color: #2d9574;">'Lewis'</span>]]
<span style="color: #3a81c3; font-weight: bold;">for</span> x <span style="color: #3a81c3; font-weight: bold;">in</span> flatten(items):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(x)
</pre>
</div>
</div>
</div>
<div id="outline-container-org2f25be2" class="outline-3">
<h3 id="org2f25be2"><span class="section-number-3">5.8</span> Merge Two Sorted Iterables</h3>
<div class="outline-text-3" id="text-5-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> heapq
<span style="color: #715ab1;">a</span> = [1, 4, 7, 10]
<span style="color: #715ab1;">b</span> = [2, 5, 6, 11]
<span style="color: #3a81c3; font-weight: bold;">for</span> c <span style="color: #3a81c3; font-weight: bold;">in</span> heapq.merge(a, b):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(c)
</pre>
</div>
</div>
</div>
<div id="outline-container-org6219ea4" class="outline-3">
<h3 id="org6219ea4"><span class="section-number-3">5.9</span> <code>iter()</code></h3>
<div class="outline-text-3" id="text-5-9">
<p>
<a id="orgd4e5ba0"></a>
<code>iter()</code> optionally accepts a zero-argument <b>callable</b> and <b>sentinel</b> (terminating) value as inputs.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">for</span> chunk <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">iter</span>(<span style="color: #3a81c3; font-weight: bold;">lambda</span>: fs.read(10), <span style="color: #2d9574;">''</span>):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(chunk)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd70406f" class="outline-2">
<h2 id="orgd70406f"><span class="section-number-2">6</span> I/O</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orga99c90b" class="outline-3">
<h3 id="orga99c90b"><span class="section-number-3">6.1</span> Encoding</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'somefile.txt'</span>, <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'latin-1'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    ...
</pre>
</div>
<p>
<b>latin-1</b> encoding is notable in that it will never produce a decoding error when reading text of a possibly unknown encoding.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Replace bad chars with Unicode U+fffd replacement char</span>
<span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'sample.txt'</span>, <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'ascii'</span>, errors=<span style="color: #2d9574;">'replace'</span>)

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ignore bad chars entirely</span>
<span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'sample.txt'</span>, <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'ascii'</span>, errors=<span style="color: #2d9574;">'ignore'</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org37ff6b7" class="outline-3">
<h3 id="org37ff6b7"><span class="section-number-3">6.2</span> <code>readinto</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> array
<span style="color: #715ab1;">a</span> = array.array(<span style="color: #2d9574;">'i'</span>, [0, 0, 0, 0, 0, 0, 0, 0])
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'data.bin'</span>, <span style="color: #2d9574;">'rb'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    f.readinto(a)
</pre>
</div>
<p>
<code>readinto()</code> fills the contents of an existing buffer
</p>
<ul class="org-ul">
<li>One caution with using <code>f.readinto()~</code> is that you must always make sure to check its return code, which is the number of bytes actually read.</li>
</ul>
</div>
</div>
<div id="outline-container-orgd000704" class="outline-3">
<h3 id="orgd000704"><span class="section-number-3">6.3</span> <code>io.StringIO</code>, <code>io.BytesIO</code></h3>
</div>
<div id="outline-container-org795950f" class="outline-3">
<h3 id="org795950f"><span class="section-number-3">6.4</span> <code>gzip.open</code>, <code>bz2.open</code></h3>
</div>
<div id="outline-container-orged7694c" class="outline-3">
<h3 id="orged7694c"><span class="section-number-3">6.5</span> Iterating Over Fixed-Sized Records</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> partial

<span style="color: #715ab1;">RECORD_SIZE</span> = 32

<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'somefile.data'</span>, <span style="color: #2d9574;">'rb'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #715ab1;">records</span> = <span style="color: #3a81c3;">iter</span>(partial(f.read, RECORD_SIZE), b<span style="color: #2d9574;">''</span>)
    <span style="color: #3a81c3; font-weight: bold;">for</span> r <span style="color: #3a81c3; font-weight: bold;">in</span> records:
        ...
</pre>
</div>
<ul class="org-ul">
<li><a href="#orgd4e5ba0">5.9</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8efcbe2" class="outline-3">
<h3 id="org8efcbe2"><span class="section-number-3">6.6</span> In-memory Modification</h3>
<div class="outline-text-3" id="text-6-6">
</div>
<div id="outline-container-orgb55934e" class="outline-4">
<h4 id="orgb55934e"><span class="section-number-4">6.6.1</span> <code>nmap</code></h4>
<div class="outline-text-4" id="text-6-6-1">
<p>
Use the <code>mmap</code> module to memory map files for random access to its contents or to make in-place modifications.
</p>
<ul class="org-ul">
<li><code>nmap</code> also can be used to exchange data between interpreters</li>
</ul>
</div>
</div>

<div id="outline-container-orgf08372e" class="outline-4">
<h4 id="orgf08372e"><span class="section-number-4">6.6.2</span> <code>memoryview</code></h4>
<div class="outline-text-4" id="text-6-6-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">buf</span> = <span style="color: #3a81c3;">bytearray</span>(b<span style="color: #2d9574;">'Hello World'</span>)
<span style="color: #715ab1;">m1</span> = <span style="color: #3a81c3;">memoryview</span>(buf)
<span style="color: #715ab1;">m2</span> = m1[-5:]
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">m2=&gt; &lt;memory at 0x100681390&gt;</span>
<span style="color: #715ab1;">m2</span>[:] = b<span style="color: #2d9574;">'WORLD'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">buf=&gt; bytearray(b'Hello WORLD')</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6d8d532" class="outline-3">
<h3 id="org6d8d532"><span class="section-number-3">6.7</span> <code>os.path</code></h3>
<div class="outline-text-3" id="text-6-7">
<div class="org-src-container">
<pre class="src src-python">os.path.basename(path)
os.path.dirname(path)
os.path.expanduser(path)
os.path.splitext(path)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Split the file extension</span>
os.path.exists(path)
os.path.isfile(path) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">isdir, islink</span>
os.path.realpath(<span style="color: #2d9574;">'/usr/local/bin/python3'</span>) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '/usr/local/bin/python3.3'</span>
os.path.getsize() <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">getmtime</span>
os.listdir(<span style="color: #3a81c3;">dir</span>)
</pre>
</div>
<ul class="org-ul">
<li>other module: <code>glob</code>, <code>fnmatch</code> used for filename matching</li>
</ul>
</div>
</div>
<div id="outline-container-orgf035a7b" class="outline-3">
<h3 id="orgf035a7b"><span class="section-number-3">6.8</span> Changing Encoding of a File</h3>
<div class="outline-text-3" id="text-6-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> io
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">decode a binary file</span>
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'some_binary_file.bin'</span>, <span style="color: #2d9574;">'rb'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> open_file:
    <span style="color: #715ab1;">fs</span> = io.TextIOWrapper(open_file, encoding=<span style="color: #2d9574;">'utf8'</span>)
    <span style="color: #715ab1;">text</span> = fs.read()

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">change encoding</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> sys
sys.stdout.encoding  <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 'UTF-8'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use its detach() method to remove the existing text encoding layer before repl</span><span style="color: #6c4173; background-color: #ecf3ec;">acing it with a new one</span>
<span style="color: #715ab1;">sys.stdout</span> = io.TextIOWrapper(sys.stdout.detach(), encoding=<span style="color: #2d9574;">'latin-1'</span>)
sys.stdout.encoding <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 'latin-1'</span>
</pre>
</div>
<ul class="org-ul">
<li>layers on I/O:</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">f</span> = <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'sample.txt'</span>, <span style="color: #2d9574;">'w'</span>)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">a text-handling layer that encodes and decodes Unicode</span>
f <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; &lt;_io.TextIOWrapper name='sample.txt' mode='w' encoding='UTF-8'&gt;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">a buffered I/O layer that handles binary data</span>
f.<span style="color: #3a81c3;">buffer</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; &lt;_io.BufferedWriter name='sample.txt'&gt;</span>
f.<span style="color: #3a81c3;">buffer</span>.write(b<span style="color: #2d9574;">'hello\n'</span>) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">write bytes to a text file</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">io.FileIO is a raw file representing the low-level file descriptor in the oper</span><span style="color: #6c4173; background-color: #ecf3ec;">ating system</span>
f.<span style="color: #3a81c3;">buffer</span>.raw <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; &lt;_io.FileIO name='sample.txt' mode='wb'&gt;</span>
</pre>
</div>
<ul class="org-ul">
<li><code>detach</code>: disconnects the topmost layer of a file and returns the next lower layer.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf67c37a" class="outline-3">
<h3 id="orgf67c37a"><span class="section-number-3">6.9</span> File Descriptor</h3>
<div class="outline-text-3" id="text-6-9">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Create a file object, but don't close underlying fd when done</span>
<span style="color: #715ab1;">f</span> = <span style="color: #3a81c3;">open</span>(fd, <span style="color: #2d9574;">'wt'</span>, closefd=<span style="color: #4e3163;">False</span>)

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">echo_client</span>(client_sock, addr):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Got connection from'</span>, addr)

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Make text-mode file wrappers for socket reading/writing, only works on Uni</span><span style="color: #6c4173; background-color: #ecf3ec;">x-based systems</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Use the makefile() method of sockets instead to be cross platform</span>
    <span style="color: #715ab1;">client_in</span> = <span style="color: #3a81c3;">open</span>(client_sock.fileno(), <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'latin-1'</span>,
                         closefd=<span style="color: #4e3163;">False</span>)
    <span style="color: #715ab1;">client_out</span> = <span style="color: #3a81c3;">open</span>(client_sock.fileno(), <span style="color: #2d9574;">'wt'</span>, encoding=<span style="color: #2d9574;">'latin-1'</span>,
                          closefd=<span style="color: #4e3163;">False</span>)

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Echo lines back to the client using file I/O</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> line <span style="color: #3a81c3; font-weight: bold;">in</span> client_in:
        client_out.write(line)
        client_out.flush()
    client_sock.close()
</pre>
</div>
</div>
</div>
<div id="outline-container-org1b6cdd6" class="outline-3">
<h3 id="org1b6cdd6"><span class="section-number-3">6.10</span> Temporary Files</h3>
<div class="outline-text-3" id="text-6-10">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> tempfile <span style="color: #3a81c3; font-weight: bold;">import</span> TemporaryFile, NamedTemporaryFile, TemporaryDirectory
<span style="color: #3a81c3; font-weight: bold;">with</span> TemporaryFile(<span style="color: #2d9574;">'w+t'</span>, encoding=<span style="color: #2d9574;">'utf-8'</span>, errors=<span style="color: #2d9574;">'ignore'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    f.write(<span style="color: #2d9574;">'Hello World\n'</span>)

<span style="color: #3a81c3; font-weight: bold;">with</span> NamedTemporaryFile(
        <span style="color: #2d9574;">'w+t'</span>, delete=<span style="color: #4e3163;">False</span>, prefix=<span style="color: #2d9574;">'mytemp'</span>, suffix=<span style="color: #2d9574;">'.txt'</span>, <span style="color: #3a81c3;">dir</span>=<span style="color: #2d9574;">'/tmp'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'filename is:'</span>, f.name)  <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; /tmp/mytemp2tmz4nl5.txt</span>

<span style="color: #3a81c3; font-weight: bold;">with</span> TemporaryDirectory() <span style="color: #3a81c3; font-weight: bold;">as</span> dirname:
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'dirname is:'</span>, dirname)
</pre>
</div>
</div>
</div>

<div id="outline-container-org77531d6" class="outline-3">
<h3 id="org77531d6"><span class="section-number-3">6.11</span> Serializing Python Objects</h3>
<div class="outline-text-3" id="text-6-11">
<p>
<code>pickle</code> is a Python-specific self-describing data encoding
</p>
</div>
<div id="outline-container-org214bca8" class="outline-4">
<h4 id="org214bca8"><span class="section-number-4">6.11.1</span> Dealing with Multiple Objects</h4>
<div class="outline-text-4" id="text-6-11-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> pickle
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'somedata'</span>, <span style="color: #2d9574;">'wb'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> fs:
    pickle.dump([1, 2, 3, 4], fs)
    pickle.dump(<span style="color: #2d9574;">'hello'</span>, fs)

<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'somedata'</span>, <span style="color: #2d9574;">'rb'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> fs:
    pickle.load(fs) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; [1, 2, 3, 4]</span>
    pickle.load(fs) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; hello</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org391a58a" class="outline-4">
<h4 id="org391a58a"><span class="section-number-4">6.11.2</span> Safety</h4>
<div class="outline-text-4" id="text-6-11-2">
<p>
<code>pickle.load()</code> should never be used on untrusted data
</p>
</div>
</div>

<div id="outline-container-orgfb4f082" class="outline-4">
<h4 id="orgfb4f082"><span class="section-number-4">6.11.3</span> User-defined Classes</h4>
<div class="outline-text-4" id="text-6-11-3">
<p>
Certain kinds of objects can’t be pickled. These are typically objects that involve some sort of external system state, such as open files,
open network connections, threads, processes, stack frames, and so forth. User-defined classes can sometimes work around these limitations
by providing <code>__getstate__()</code> and <code>__setstate__()</code> methods
</p>
<ul class="org-ul">
<li><code>pickle.dump()</code> will call <code>__getstate__()</code> to get an object that can be pickled</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org7f673ff" class="outline-2">
<h2 id="org7f673ff"><span class="section-number-2">7</span> Encoding</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org915ed26" class="outline-3">
<h3 id="org915ed26"><span class="section-number-3">7.1</span> csv</h3>
<div class="outline-text-3" id="text-7-1">
</div>
<div id="outline-container-org5a736f6" class="outline-4">
<h4 id="org5a736f6"><span class="section-number-4">7.1.1</span> <code>reader</code></h4>
<div class="outline-text-4" id="text-7-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> namedtuple
<span style="color: #3a81c3; font-weight: bold;">import</span> re
<span style="color: #3a81c3; font-weight: bold;">import</span> csv
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'stock.csv'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #715ab1;">f_csv</span> = csv.reader(f)
    <span style="color: #715ab1;">headings</span> = <span style="color: #3a81c3;">next</span>(f_csv)
    <span style="color: #715ab1;">Row</span> = namedtuple(<span style="color: #2d9574;">'Row'</span>, headings)
    <span style="color: #3a81c3; font-weight: bold;">for</span> r <span style="color: #3a81c3; font-weight: bold;">in</span> f_csv:
        <span style="color: #715ab1;">row</span> = Row(*r)
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Process row</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga08bcf8" class="outline-4">
<h4 id="orga08bcf8"><span class="section-number-4">7.1.2</span> <code>DictReader</code></h4>
<div class="outline-text-4" id="text-7-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> csv
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'stocks.csv'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #715ab1;">f_csv</span> = csv.DictReader(f)
    <span style="color: #3a81c3; font-weight: bold;">for</span> row <span style="color: #3a81c3; font-weight: bold;">in</span> f_csv:
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">process row</span>
        ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org781a2ab" class="outline-4">
<h4 id="org781a2ab"><span class="section-number-4">7.1.3</span> <code>writer</code></h4>
<div class="outline-text-4" id="text-7-1-3">
<ul class="org-ul">
<li><code>writer.writerow</code> and <code>writer.writerows</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgeb542fd" class="outline-4">
<h4 id="orgeb542fd"><span class="section-number-4">7.1.4</span> <code>DictWriter</code></h4>
<div class="outline-text-4" id="text-7-1-4">
<ul class="org-ul">
<li><code>writer.writeheader</code> and <code>writer.writerows</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb19db16" class="outline-3">
<h3 id="orgb19db16"><span class="section-number-3">7.2</span> json2object</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>use <code>object_pairs_hook</code> and <code>object_hook</code> options</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> json
<span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> OrderedDict
<span style="color: #715ab1;">s</span> = <span style="color: #2d9574;">'{"name": "ACME", "shares": 50, "price": 490.1}'</span>
<span style="color: #715ab1;">data</span> = json.loads(s, object_pairs_hook=OrderedDict)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">data =&gt; OrderedDict([('name', 'ACME'), ('shares', 50), ('price', 490.1)])</span>

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">JSONObject</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, d):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.__dict__ = d

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__str__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">str</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>.__dict__)


<span style="color: #715ab1;">obj</span> = json.loads(s, object_hook=JSONObject)
<span style="color: #715ab1;">obj.name</span> = <span style="color: #2d9574;">'def'</span>

json.dumps(<span style="color: #3a81c3;">vars</span>(obj)) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">vars(obj) same as obj.__dict__</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">or</span>
json.dumps(obj, default=<span style="color: #3a81c3;">vars</span>) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use vars as a serializing function</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7278f1d" class="outline-3">
<h3 id="org7278f1d"><span class="section-number-3">7.3</span> xml</h3>
<div class="outline-text-3" id="text-7-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> xml.etree.ElementTree <span style="color: #3a81c3; font-weight: bold;">import</span> parse
<span style="color: #715ab1;">doc</span> = parse(xml_str)
</pre>
</div>
<ul class="org-ul">
<li><code>lxml</code></li>
<li>for huge xml: <code>Recipe 6.4</code></li>
<li>more: <code>Recipe 6.3~6.7</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgdab6a6c" class="outline-3">
<h3 id="orgdab6a6c"><span class="section-number-3">7.4</span> hex encoding</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li><code>binascii</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> binascii

<span style="color: #715ab1;">s</span> = b<span style="color: #2d9574;">'hello'</span>
<span style="color: #715ab1;">h</span> = binascii.b2a_hex(s) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bytes2hexbytes b'68656c6c6f'</span>
<span style="color: #715ab1;">b</span> = binascii.a2b_hex(h) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">hexbytes2bytes</span>
</pre>
</div>
<ul class="org-ul">
<li><code>base64</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> base64
<span style="color: #715ab1;">s</span> = b<span style="color: #2d9574;">'hello'</span>
<span style="color: #715ab1;">h</span> = base64.b16encode(s) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">b'68656C6C6F' uppercase</span>
<span style="color: #715ab1;">b</span> = base64.b16decode(h)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4b46919" class="outline-3">
<h3 id="org4b46919"><span class="section-number-3">7.5</span> base64</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li><code>base64.b64encode</code></li>
<li><code>base64.b64decode</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgcbba707" class="outline-3">
<h3 id="orgcbba707"><span class="section-number-3">7.6</span> struct</h3>
<div class="outline-text-3" id="text-7-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> struct <span style="color: #3a81c3; font-weight: bold;">import</span> Struct

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">write_records</span>(records: <span style="color: #3a81c3;">tuple</span>, <span style="color: #3a81c3;">format</span>, f):
    <span style="color: #715ab1;">record_struct</span> = Struct(<span style="color: #3a81c3;">format</span>)
    <span style="color: #3a81c3; font-weight: bold;">for</span> r <span style="color: #3a81c3; font-weight: bold;">in</span> records:
        f.write(record_struct.pack(*r))

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">read_records</span>(<span style="color: #3a81c3;">format</span>, f) -&gt; <span style="color: #3a81c3;">tuple</span>:
    <span style="color: #715ab1;">record_struct</span> = Struct(<span style="color: #3a81c3;">format</span>)
    <span style="color: #715ab1;">chunks</span> = <span style="color: #3a81c3;">iter</span>(<span style="color: #3a81c3; font-weight: bold;">lambda</span>: f.read(record_struct.size), b<span style="color: #2d9574;">''</span>) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">star!</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> (record_struct.unpack(chunk) <span style="color: #3a81c3; font-weight: bold;">for</span> chunk <span style="color: #3a81c3; font-weight: bold;">in</span> chunks) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">star!</span>

</pre>
</div>
<ul class="org-ul">
<li>more to explore <code>Recipe 6.12</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgddb6ec2" class="outline-2">
<h2 id="orgddb6ec2"><span class="section-number-2">8</span> Functions</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org54181d3" class="outline-3">
<h3 id="org54181d3"><span class="section-number-3">8.1</span> Keyword-only Arguments</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">recv</span>(maxsize, *, block):
    <span style="color: #3a81c3; font-weight: bold;">pass</span>

recv(1024, <span style="color: #4e3163;">True</span>)<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">TypeError</span>
recv(1024, block=<span style="color: #4e3163;">True</span>) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">OK</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org83b2ff9" class="outline-3">
<h3 id="org83b2ff9"><span class="section-number-3">8.2</span> Capture Variables</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">x</span> = 10
<span style="color: #715ab1;">a</span> = <span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #715ab1;">y</span>, <span style="color: #715ab1;">x</span>=x: x + y <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use x=x to bind at definition time</span>
<span style="color: #715ab1;">x</span> = 20
a(5) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 15</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4da434b" class="outline-3">
<h3 id="org4da434b"><span class="section-number-3">8.3</span> Replace Single-method Classes with Closures</h3>
</div>

<div id="outline-container-orge747c0e" class="outline-3">
<h3 id="orge747c0e"><span class="section-number-3">8.4</span> Callback Shared State</h3>
<div class="outline-text-3" id="text-8-4">
<p>
<code>Recipe 7.10</code> four ways:
</p>
<ul class="org-ul">
<li>single-method class</li>
<li>closure</li>
<li>coroutine: use coroutine.send as callback</li>
<li>use <code>functools.partial</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc9c0c44" class="outline-2">
<h2 id="orgc9c0c44"><span class="section-number-2">9</span> Class</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgc93666b" class="outline-3">
<h3 id="orgc93666b"><span class="section-number-3">9.1</span> String Representation</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li><code>__repr__</code>: returns the code representation of an instance, and is usually the text you would type to recreate the instance. <code>eval(repr(x)) == x</code></li>
<li><code>__str__</code>: converts the instance to a string.</li>
</ul>
</div>
</div>

<div id="outline-container-org87d2a20" class="outline-3">
<h3 id="org87d2a20"><span class="section-number-3">9.2</span> <code>__format__</code></h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">_formats</span> = {
    <span style="color: #2d9574;">'ymd'</span> : <span style="color: #2d9574;">'{d.year}-{d.month}-{d.day}'</span>,
    <span style="color: #2d9574;">'mdy'</span> : <span style="color: #2d9574;">'{d.month}/{d.day}/{d.year}'</span>,
    <span style="color: #2d9574;">'dmy'</span> : <span style="color: #2d9574;">'{d.day}/{d.month}/{d.year}'</span>
    }
<span style="color: #3a81c3; font-weight: bold;">from</span> datetime <span style="color: #3a81c3; font-weight: bold;">import</span> date
<span style="color: #715ab1;">d</span> = date.today()
<span style="color: #3a81c3;">format</span>(d, <span style="color: #2d9574;">'mdy'</span>)
<span style="color: #2d9574;">'The date is {:ymd}'</span>.<span style="color: #3a81c3;">format</span>(d)
</pre>
</div>
</div>
</div>

<div id="outline-container-org56cbf33" class="outline-3">
<h3 id="org56cbf33"><span class="section-number-3">9.3</span> Context Management</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Connection</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__enter__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.fs = <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'somefile.txt'</span>, <span style="color: #2d9574;">'rt'</span>)
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.fs

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__exit__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, exc_ty, exc_val, tb):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.fs.close()
        <span style="color: #3a81c3; font-weight: bold;">self</span>.fs = <span style="color: #4e3163;">None</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8121ba" class="outline-3">
<h3 id="orgf8121ba"><span class="section-number-3">9.4</span> Saving Memory <code>__slots__</code></h3>
<div class="outline-text-3" id="text-9-4">
<ul class="org-ul">
<li>Instances are built around a small fixed-sized array instead of a dictionary.</li>
<li>A side effect of using slots is that it is no longer possible to add new attributes to instances.</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Date</span>:
    <span style="color: #715ab1;">__slots__</span> = [<span style="color: #2d9574;">'year'</span>, <span style="color: #2d9574;">'month'</span>, <span style="color: #2d9574;">'day'</span>]
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, year, month, day):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.year = year
        <span style="color: #3a81c3; font-weight: bold;">self</span>.month = month
        <span style="color: #3a81c3; font-weight: bold;">self</span>.day = day
</pre>
</div>
</div>
</div>

<div id="outline-container-org8b585f7" class="outline-3">
<h3 id="org8b585f7"><span class="section-number-3">9.5</span> Properties</h3>
<div class="outline-text-3" id="text-9-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Object</span>:
    <span style="color: #ba2f59; font-weight: bold;">@property</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__attr

    <span style="color: #ba2f59; font-weight: bold;">@attr.setter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, value):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.__attr = value

    <span style="color: #ba2f59; font-weight: bold;">@attr.deleter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.__attr = <span style="color: #4e3163;">None</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">del obj.attr</span>
</pre>
</div>
</div>
<div id="outline-container-org2f77874" class="outline-4">
<h4 id="org2f77874"><span class="section-number-4">9.5.1</span> Extending a Property</h4>
<div class="outline-text-4" id="text-9-5-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">SubPerson</span>(Person):
    <span style="color: #ba2f59; font-weight: bold;">@property</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Getting name'</span>)
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span>().name

    <span style="color: #ba2f59; font-weight: bold;">@name.setter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, value):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Setting name to'</span>, value)
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the only way to get to setter method is to access it as a class variab</span><span style="color: #6c4173; background-color: #ecf3ec;">le</span>
        <span style="color: #3a81c3;">super</span>(SubPerson, SubPerson).name.__set__(<span style="color: #3a81c3; font-weight: bold;">self</span>, value)

    <span style="color: #ba2f59; font-weight: bold;">@name.deleter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Deleting name'</span>)
        <span style="color: #3a81c3;">super</span>(SubPerson, SubPerson).name.__delete__(<span style="color: #3a81c3; font-weight: bold;">self</span>)
</pre>
</div>
<ul class="org-ul">
<li><p>
Extending only <code>getter</code> method
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">SubPerson</span>(Person):
    <span style="color: #ba2f59; font-weight: bold;">@Person.name.getter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Getting name'</span>)
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span>().name
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org8345e89" class="outline-3">
<h3 id="org8345e89"><span class="section-number-3">9.6</span> <code>super()</code></h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li>To avoid double-invocation when involving multiple inheritance.</li>
<li>Use <code>__mro__</code> to see method resolution order.</li>
</ul>
</div>

<div id="outline-container-org3b298e8" class="outline-4">
<h4 id="org3b298e8"><span class="section-number-4">9.6.1</span> MRO</h4>
<div class="outline-text-4" id="text-9-6-1">
<p>
The actual determination of the MRO list itself is made using a technique known as C3 Linearization.
</p>
<ul class="org-ul">
<li>Child classes get checked before parents.</li>
<li>Multiple parents get checked in the order listed.</li>
<li>If there are two valid choices for the next class, pick the one from the first parent.</li>
</ul>
<p>
When you use the <code>super()</code> function, Python continues its search starting with the next class on the MRO. See Chapter 8.7 <a href="https://rhettinger.wordpress.com/2011/05/26/super-considered-super/">More details</a>.
</p>

<ul class="org-ul">
<li>Hint: <code>super(MyClass, self).__init__()</code> provides the next <code>__init__</code> method according to the used Method Resolution Ordering(MRO)</li>
</ul>
</div>
</div>
<div id="outline-container-org3cd9663" class="outline-4">
<h4 id="org3cd9663"><span class="section-number-4">9.6.2</span> Multiple Inheritance with Different Arguments to Constructors</h4>
<div class="outline-text-4" id="text-9-6-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">A</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, a, **kw):
        <span style="color: #3a81c3;">super</span>().__init__(**kw)
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'A a'</span>, a)


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">B</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, b, c=0, **kw):
        <span style="color: #3a81c3;">super</span>().__init__(**kw)
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'B b'</span>, b)
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'B c'</span>, c)


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">C</span>(A, B):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, a, b, c, d):
        <span style="color: #3a81c3;">super</span>().__init__(a=a, b=b, c=c)
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'C d'</span>, d)
</pre>
</div>
<p>
or
</p>
<div class="org-src-container">
<pre class="src src-python"> <span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">C</span>(A, B):
     <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, a, b, c):
         A.__init__(<span style="color: #3a81c3; font-weight: bold;">self</span>, a)
         B.__init__(<span style="color: #3a81c3; font-weight: bold;">self</span>, b, c)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">should be careful with double-invocation</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org60f73f1" class="outline-3">
<h3 id="org60f73f1"><span class="section-number-3">9.7</span> <b>Descriptor</b></h3>
<div class="outline-text-3" id="text-9-7">
<p>
Use Descriptor to create a new kind of instance attribute with some extra functionality, such as type checking.
Descriptors provide the underlying magic for most of Python’s class features, such as <code>@classmethod</code>, <code>@staticmethod</code>, <code>@property</code>.
</p>
<ul class="org-ul">
<li><code>__get__(self, instance, cls)</code></li>
<li><code>__set__(self, instance, value)</code></li>
<li><code>__delete__(self, instance)</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">String</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls):
        <span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">called as class variable</span>
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
        <span style="color: #3a81c3; font-weight: bold;">return</span> instance.__dict__[<span style="color: #3a81c3; font-weight: bold;">self</span>.name]

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span>(value, <span style="color: #3a81c3;">str</span>):
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">'Expected a string'</span>)
        <span style="color: #715ab1;">instance.__dict__</span>[<span style="color: #3a81c3; font-weight: bold;">self</span>.name] = value

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__delete__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance):
        <span style="color: #3a81c3; font-weight: bold;">del</span> instance.__dict__[<span style="color: #3a81c3; font-weight: bold;">self</span>.name]


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Person</span>:
    <span style="color: #715ab1;">name</span> = String(<span style="color: #2d9574;">'name'</span>)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
</pre>
</div>
</div>
<div id="outline-container-orgf7c5864" class="outline-4">
<h4 id="orgf7c5864"><span class="section-number-4">9.7.1</span> Advanced Usage</h4>
<div class="outline-text-4" id="text-9-7-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Descriptor for a type-checked attribute</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Typed</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, expected_type):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
        <span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type = expected_type

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls):
        <span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
        <span style="color: #3a81c3; font-weight: bold;">else</span>:
            <span style="color: #3a81c3; font-weight: bold;">return</span> instance.__dict__[<span style="color: #3a81c3; font-weight: bold;">self</span>.name]

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span>(value, <span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type):
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">'Expected '</span> + <span style="color: #3a81c3;">str</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type))
        <span style="color: #715ab1;">instance.__dict__</span>[<span style="color: #3a81c3; font-weight: bold;">self</span>.name] = value

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__delete__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance):
        <span style="color: #3a81c3; font-weight: bold;">del</span> instance.__dict__[<span style="color: #3a81c3; font-weight: bold;">self</span>.name]


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Class decorator that applies it to selected attributes</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">typeassert</span>(**kwargs):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">decorate</span>(cls):
        <span style="color: #3a81c3; font-weight: bold;">for</span> name, expected_type <span style="color: #3a81c3; font-weight: bold;">in</span> kwargs.items():
            <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Attach a Typed descriptor to the class</span>
            <span style="color: #3a81c3;">setattr</span>(cls, name, Typed(name, expected_type))
            <span style="color: #3a81c3; font-weight: bold;">return</span> cls

    <span style="color: #3a81c3; font-weight: bold;">return</span> decorate


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example use</span>
<span style="color: #ba2f59; font-weight: bold;">@typeassert</span>(name=<span style="color: #3a81c3;">str</span>, shares=<span style="color: #3a81c3;">int</span>, price=<span style="color: #3a81c3;">float</span>)
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, shares, price):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
        <span style="color: #3a81c3; font-weight: bold;">self</span>.shares = shares
        <span style="color: #3a81c3; font-weight: bold;">self</span>.price = price
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfbe7bb4" class="outline-4">
<h4 id="orgfbe7bb4"><span class="section-number-4">9.7.2</span> Lazy Properties</h4>
<div class="outline-text-4" id="text-9-7-2">
<p>
Define a read-only attribute as a property that only gets computed on access.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">lazyproperty</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, func):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.func = func

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls):
        <span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
        <span style="color: #3a81c3; font-weight: bold;">else</span>:
            <span style="color: #715ab1;">value</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.func(instance)
            <span style="color: #3a81c3;">setattr</span>(instance, <span style="color: #3a81c3; font-weight: bold;">self</span>.func.<span style="color: #3a81c3;">__name__</span>, value)
            <span style="color: #3a81c3; font-weight: bold;">return</span> value


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Circle</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, radius):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.radius = radius

    <span style="color: #ba2f59; font-weight: bold;">@lazyproperty</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">area</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Computing area'</span>)
        <span style="color: #3a81c3; font-weight: bold;">return</span> math.pi * <span style="color: #3a81c3; font-weight: bold;">self</span>.radius**2
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a01137" class="outline-4">
<h4 id="org6a01137"><span class="section-number-4">9.7.3</span> Data Model</h4>
<div class="outline-text-4" id="text-9-7-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Base class. Uses a descriptor to set a value</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Descriptor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name=<span style="color: #4e3163;">None</span>, **opts):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
        <span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> opts.items():
            <span style="color: #3a81c3;">setattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, key, value)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value):
        <span style="color: #715ab1;">instance.__dict__</span>[<span style="color: #3a81c3; font-weight: bold;">self</span>.name] = value


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Descriptor for enforcing types</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Typed</span>(Descriptor):
    <span style="color: #715ab1;">expected_type</span> = <span style="color: #3a81c3;">type</span>(<span style="color: #4e3163;">None</span>)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span>(value, <span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type):
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">'expected '</span> + <span style="color: #3a81c3;">str</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type))
        <span style="color: #3a81c3;">super</span>().__set__(instance, value)


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Descriptor for enforcing values</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Unsigned</span>(Descriptor):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value):
        <span style="color: #3a81c3; font-weight: bold;">if</span> value &lt; 0:
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">ValueError</span>(<span style="color: #2d9574;">'Expected &gt;= 0'</span>)
        <span style="color: #3a81c3;">super</span>().__set__(instance, value)


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Integer</span>(Typed):
    <span style="color: #715ab1;">expected_type</span> = <span style="color: #3a81c3;">int</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">UnsignedInteger</span>(Integer, Unsigned):
    <span style="color: #3a81c3; font-weight: bold;">pass</span>
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="org1bc196d"></a>Simplify the Specification by Class Decorator<br />
<div class="outline-text-5" id="text-org1bc196d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Class decorator to apply constraints</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">check_attributes</span>(**kwargs):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">decorate</span>(cls):
        <span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> kwargs.items():
            <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span>(value, Descriptor):
                <span style="color: #715ab1;">value.name</span> = key
                <span style="color: #3a81c3;">setattr</span>(cls, key, value)
            <span style="color: #3a81c3; font-weight: bold;">else</span>:
                <span style="color: #3a81c3;">setattr</span>(cls, key, value(key))
        <span style="color: #3a81c3; font-weight: bold;">return</span> cls
    <span style="color: #3a81c3; font-weight: bold;">return</span> decorate

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example</span>
<span style="color: #ba2f59; font-weight: bold;">@check_attributes</span>(name=SizedString(size=8),
                  shares=UnsignedInteger,
                  price=UnsignedFloat)
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, shares, price):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
        <span style="color: #3a81c3; font-weight: bold;">self</span>.shares = shares
        <span style="color: #3a81c3; font-weight: bold;">self</span>.price = price
</pre>
</div>
</div>
</li>

<li><a id="org2315f8a"></a>Simplify the Specification by Metaclass<br />
<div class="outline-text-5" id="text-org2315f8a">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">A metaclass that applies checking</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">checkedmeta</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span>(cls, clsname, bases, methods):
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Attach attribute names to the descriptors</span>
        <span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> methods.items():
            <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span>(value, Descriptor):
                <span style="color: #715ab1;">value.name</span> = key
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">type</span>.__new__(cls, clsname, bases, methods)


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>(metaclass=checkedmeta):
    <span style="color: #715ab1;">name</span> = SizedString(size=8)
    <span style="color: #715ab1;">shares</span> = UnsignedInteger() <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">no need to give a name</span>
    <span style="color: #715ab1;">price</span> = UnsignedFloat()

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, shares, price):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
        <span style="color: #3a81c3; font-weight: bold;">self</span>.shares = shares
        <span style="color: #3a81c3; font-weight: bold;">self</span>.price = price
</pre>
</div>
</div>
</li>

<li><a id="org0b27c51"></a>Decorator Version(Preferred Approach)<br />
<div class="outline-text-5" id="text-org0b27c51">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Base class. Uses a descriptor to set a value</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Descriptor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name=<span style="color: #4e3163;">None</span>, **opts):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
        <span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> opts.items():
            <span style="color: #3a81c3;">setattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, key, value)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value):
        <span style="color: #715ab1;">instance.__dict__</span>[<span style="color: #3a81c3; font-weight: bold;">self</span>.name] = value


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Decorator for applying type checking</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">Typed</span>(expected_type, cls=<span style="color: #4e3163;">None</span>):
    <span style="color: #3a81c3; font-weight: bold;">if</span> cls <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">lambda</span> cls: Typed(expected_type, cls)

    <span style="color: #715ab1;">super_set</span> = cls.__set__

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span>(value, expected_type):
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">'expected '</span> + <span style="color: #3a81c3;">str</span>(expected_type))
        super_set(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value)

    <span style="color: #715ab1;">cls.__set__</span> = __set__
    <span style="color: #3a81c3; font-weight: bold;">return</span> cls


<span style="color: #ba2f59; font-weight: bold;">@Typed</span>(<span style="color: #3a81c3;">int</span>)
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Integer</span>(Descriptor):
    <span style="color: #3a81c3; font-weight: bold;">pass</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org783e7f9" class="outline-3">
<h3 id="org783e7f9"><span class="section-number-3">9.8</span> Simplifying Initialization</h3>
<div class="outline-text-3" id="text-9-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Structure</span>:
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Class variable that specifies expected fields</span>
    <span style="color: #715ab1;">_fields</span> = []

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">len</span>(args) != <span style="color: #3a81c3;">len</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>._fields):
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">'Expected {} arguments'</span>.<span style="color: #3a81c3;">format</span>(<span style="color: #3a81c3;">len</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>._fields)))

        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Set the arguments</span>
        <span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">zip</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>._fields, args):
            <span style="color: #3a81c3;">setattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, value)


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>(Structure):
    <span style="color: #715ab1;">_fields</span> = [<span style="color: #2d9574;">'name'</span>, <span style="color: #2d9574;">'shares'</span>, <span style="color: #2d9574;">'price'</span>]
</pre>
</div>
<ul class="org-ul">
<li>Downside: documentation and help features of IDEs. It can be solved by attaching or enforcing a type signature</li>
</ul>
</div>
</div>

<div id="outline-container-orgbc6e343" class="outline-3">
<h3 id="orgbc6e343"><span class="section-number-3">9.9</span> Abstract Base Class</h3>
<div class="outline-text-3" id="text-9-9">
<ul class="org-ul">
<li>Define an abc class: <code>class AbstractBase(metaclass=abc.ABCMeta)</code></li>
<li>Using <code>register</code> to bind other class which is already defined</li>
<li><code>@abstractmethod</code> can work with <code>@staticmethod</code>, <code>@classmethod</code></li>
</ul>
</div>
</div>

<div id="outline-container-org75c5a3c" class="outline-3">
<h3 id="org75c5a3c"><span class="section-number-3">9.10</span> Implementing Custom Containers</h3>
<div class="outline-text-3" id="text-9-10">
<ul class="org-ul">
<li><code>Container</code>: <code>__contains__</code></li>
<li><code>Iterable</code>: <code>__iter__</code></li>
<li><code>Sized</code>: <code>__len__</code></li>
<li><code>Sequence</code>: <code>__getitem__</code>, <code>__len__</code></li>
<li><code>MutableSequence</code>: <code>__delitem__</code>, <code>__getitem__</code>, <code>__len__</code>, <code>__setitem__</code>, <code>insert</code></li>
</ul>
</div>
</div>

<div id="outline-container-orga52c2e9" class="outline-3">
<h3 id="orga52c2e9"><span class="section-number-3">9.11</span> Proxy Class</h3>
<div class="outline-text-3" id="text-9-11">
<p>
Implement <code>__getattr__</code>, <code>__setattr__</code>, <code>__delattr__</code>
</p>
<ul class="org-ul">
<li><code>__getattr__</code> method is actually a fallback method that only gets called when an attribute is not found.</li>
</ul>
</div>
</div>

<div id="outline-container-org9f2c7e2" class="outline-3">
<h3 id="org9f2c7e2"><span class="section-number-3">9.12</span> Multiple Constructors</h3>
<div class="outline-text-3" id="text-9-12">
<ul class="org-ul">
<li>Use <code>@classmethod</code>, example: <code>Date.today</code></li>
<li>Use <code>cls.__new__(cls)</code> to create instance without initialization.</li>
</ul>
</div>
</div>

<div id="outline-container-org7f6f54a" class="outline-3">
<h3 id="org7f6f54a"><span class="section-number-3">9.13</span> Mixin Class</h3>
<div class="outline-text-3" id="text-9-13">
<ul class="org-ul">
<li>To enhance the functionality of existing classes with optional features.</li>
<li>See Recipe 8.18, example: <code>ThreadedXMLRPCServer(ThreadingMixIn, SimpleXMLRPCServer)</code></li>
<li>Mixin classes are never meant to be instantiated directly.</li>
<li>Mixin classes typically have no state of their own(not a restriction)</li>
<li>Use <code>__slots__ = ()</code> to serve as a strong hint that the mixin classes do not have their own instance data.</li>
<li>Use class decorator to patch method(preferred approach)</li>
</ul>
</div>
</div>

<div id="outline-container-org6d78c43" class="outline-3">
<h3 id="org6d78c43"><span class="section-number-3">9.14</span> State Machine</h3>
<div class="outline-text-3" id="text-9-14">
<p>
Based on state design pattern. See Recipe 8.19, should use <code>__class__</code>
</p>
</div>
</div>

<div id="outline-container-org72b026f" class="outline-3">
<h3 id="org72b026f"><span class="section-number-3">9.15</span> Calling a Method by Name</h3>
<div class="outline-text-3" id="text-9-15">
<ul class="org-ul">
<li><code>getattr</code></li>
<li><code>operator.methodcaller()</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgd2d96bb" class="outline-3">
<h3 id="orgd2d96bb"><span class="section-number-3">9.16</span> Visitor Pattern</h3>
<div class="outline-text-3" id="text-9-16">
<p>
<b>Recipe 8.21</b>
</p>
</div>
<div id="outline-container-orge186d5d" class="outline-4">
<h4 id="orge186d5d"><span class="section-number-4">9.16.1</span> <b>Without Recursion</b></h4>
<div class="outline-text-4" id="text-9-16-1">
<p>
<b>Recipe 8.22</b>
</p>
<ul class="org-ul">
<li>Use <b>stack</b> (like depth-first traversal) and generator</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> types


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Node</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">NodeVisitor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">visit</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, node):
        <span style="color: #715ab1;">stack</span> = [node]
        <span style="color: #715ab1;">last_result</span> = <span style="color: #4e3163;">None</span>
        <span style="color: #3a81c3; font-weight: bold;">while</span> stack:
            <span style="color: #3a81c3; font-weight: bold;">try</span>:
                <span style="color: #715ab1;">last</span> = stack[-1]
                <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span>(last, types.GeneratorType):
                    stack.append(last.send(last_result))
                    <span style="color: #715ab1;">last_result</span> = <span style="color: #4e3163;">None</span>
                <span style="color: #3a81c3; font-weight: bold;">elif</span> <span style="color: #3a81c3;">isinstance</span>(last, Node):
                    stack.append(<span style="color: #3a81c3; font-weight: bold;">self</span>._visit(stack.pop()))
                <span style="color: #3a81c3; font-weight: bold;">else</span>:
                    <span style="color: #715ab1;">last_result</span> = stack.pop()
            <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span>:
                stack.pop()
        <span style="color: #3a81c3; font-weight: bold;">return</span> last_result


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">_visit</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, node):
    <span style="color: #715ab1;">methname</span> = <span style="color: #2d9574;">'visit_'</span> + <span style="color: #3a81c3;">type</span>(node).<span style="color: #3a81c3;">__name__</span>
    <span style="color: #715ab1;">meth</span> = <span style="color: #3a81c3;">getattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, methname, <span style="color: #4e3163;">None</span>)
    <span style="color: #3a81c3; font-weight: bold;">if</span> meth <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
        <span style="color: #715ab1;">meth</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.generic_visit
    <span style="color: #3a81c3; font-weight: bold;">return</span> meth(node)


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">generic_visit</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, node):
    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">RuntimeError</span>(<span style="color: #2d9574;">'No {} method'</span>.<span style="color: #3a81c3;">format</span>(<span style="color: #2d9574;">'visit_'</span> + <span style="color: #3a81c3;">type</span>(node).<span style="color: #3a81c3;">__name__</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1d9c345" class="outline-3">
<h3 id="org1d9c345"><span class="section-number-3">9.17</span> Comparison</h3>
<div class="outline-text-3" id="text-9-17">
<p>
<code>__le__</code>, <code>__ge__</code>, <code>__lt__</code>, <code>__gt__</code>, <code>__eq__</code>
</p>
</div>
</div>

<div id="outline-container-orgee7b74c" class="outline-3">
<h3 id="orgee7b74c"><span class="section-number-3">9.18</span> <code>weakref</code></h3>
<div class="outline-text-3" id="text-9-18">
</div>
<div id="outline-container-org8ae9d18" class="outline-4">
<h4 id="org8ae9d18"><span class="section-number-4">9.18.1</span> Avoid Cyclic Reference</h4>
<div class="outline-text-4" id="text-9-18-1">
<p>
<code>weakref.ref</code>
</p>
</div>
</div>

<div id="outline-container-org14ce362" class="outline-4">
<h4 id="org14ce362"><span class="section-number-4">9.18.2</span> Cache Instances(like <code>logging.getLogger</code>)</h4>
<div class="outline-text-4" id="text-9-18-2">
<p>
Use <code>weakref.WeakValueDictionary</code> to store instances as weak reference
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgda93c8c" class="outline-2">
<h2 id="orgda93c8c"><span class="section-number-2">10</span> Metaprogramming</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-org930b969" class="outline-3">
<h3 id="org930b969"><span class="section-number-3">10.1</span> <code>functools.wrap</code></h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li>Preserving function metadata, <code>__name__</code>, <code>__doc__</code>, <code>__annotations__</code>.</li>
<li>original function in <code>__wrapped__</code> (hint: <code>@classmethod</code> and <code>@staticmethod</code> store original function in <code>__func__</code>)</li>
</ul>
</div>
</div>

<div id="outline-container-orgc1507a6" class="outline-3">
<h3 id="orgc1507a6"><span class="section-number-3">10.2</span> Decorator with get/set</h3>
<div class="outline-text-3" id="text-10-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attach_wrapper</span>(obj, func=<span style="color: #4e3163;">None</span>):
    <span style="color: #3a81c3; font-weight: bold;">if</span> func <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
        <span style="color: #3a81c3; font-weight: bold;">return</span> partial(attach_wrapper, obj)
    <span style="color: #3a81c3;">setattr</span>(obj, func.<span style="color: #3a81c3;">__name__</span>, func)
    <span style="color: #3a81c3; font-weight: bold;">return</span> func
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6f26d1" class="outline-3">
<h3 id="orgc6f26d1"><span class="section-number-3">10.3</span> Decorator with Optional Arguments</h3>
<div class="outline-text-3" id="text-10-3">
<p>
example:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> logging
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> partial, wraps


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">logged</span>(func=<span style="color: #4e3163;">None</span>, *, level=logging.DEBUG, name=<span style="color: #4e3163;">None</span>, message=<span style="color: #4e3163;">None</span>):
    <span style="color: #3a81c3; font-weight: bold;">if</span> func <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
        <span style="color: #3a81c3; font-weight: bold;">return</span> partial(logged, level=level, name=name, message=message)
    <span style="color: #715ab1;">logname</span> = name <span style="color: #3a81c3; font-weight: bold;">if</span> name <span style="color: #3a81c3; font-weight: bold;">else</span> func.__module__
    <span style="color: #715ab1;">log</span> = logging.getLogger(logname)
    <span style="color: #715ab1;">logmsg</span> = message <span style="color: #3a81c3; font-weight: bold;">if</span> message <span style="color: #3a81c3; font-weight: bold;">else</span> func.<span style="color: #3a81c3;">__name__</span>

    <span style="color: #ba2f59; font-weight: bold;">@wraps</span>(func)
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">wrapper</span>(*args, **kwargs):
        log.log(level, logmsg)
        <span style="color: #3a81c3; font-weight: bold;">return</span> func(*args, **kwargs)

    <span style="color: #3a81c3; font-weight: bold;">return</span> wrapper
</pre>
</div>
</div>
</div>

<div id="outline-container-org5bfa2b3" class="outline-3">
<h3 id="org5bfa2b3"><span class="section-number-3">10.4</span> Type Checking Decorator</h3>
<div class="outline-text-3" id="text-10-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> signature
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> wraps


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">typeassert</span>(*ty_args, **ty_kwargs):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">decorate</span>(func):
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If in optimized mode, disable type checking</span>
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #4e3163;">__debug__</span>:
            <span style="color: #3a81c3; font-weight: bold;">return</span> func
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Map function argument names to supplied types</span>
        <span style="color: #715ab1;">sig</span> = signature(func)
        <span style="color: #715ab1;">bound_types</span> = sig.bind_partial(*ty_args, **ty_kwargs).arguments

        <span style="color: #ba2f59; font-weight: bold;">@wraps</span>(func)
        <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">wrapper</span>(*args, **kwargs):
            <span style="color: #715ab1;">bound_values</span> = sig.bind(*args, **kwargs)
            <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Enforce type assertions across supplied arguments</span>
            <span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> bound_values.arguments.items():
                <span style="color: #3a81c3; font-weight: bold;">if</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> bound_types:
                    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span>(value, bound_types[name]):
                        <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">'Argument {} must be {}'</span>.<span style="color: #3a81c3;">format</span>(
                            name, bound_types[name]))
            <span style="color: #3a81c3; font-weight: bold;">return</span> func(*args, **kwargs)
        <span style="color: #3a81c3; font-weight: bold;">return</span> wrapper
    <span style="color: #3a81c3; font-weight: bold;">return</span> decorate


<span style="color: #ba2f59; font-weight: bold;">@typeassert</span>(<span style="color: #3a81c3;">int</span>, z=<span style="color: #3a81c3;">int</span>)
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">add</span>(x, y, z=42):
    <span style="color: #3a81c3; font-weight: bold;">return</span> x + y + z
</pre>
</div>
</div>
</div>

<div id="outline-container-org5a89c9e" class="outline-3">
<h3 id="org5a89c9e"><span class="section-number-3">10.5</span> Decorator as Functional Class</h3>
<div class="outline-text-3" id="text-10-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> types
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> wraps


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Profiled</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, func):
        wraps(func)(<span style="color: #3a81c3; font-weight: bold;">self</span>)
        <span style="color: #3a81c3; font-weight: bold;">self</span>.ncalls = 0

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.ncalls += 1
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__wrapped__(*args, **kwargs)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls):
        <span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
        <span style="color: #3a81c3; font-weight: bold;">else</span>:
            <span style="color: #3a81c3; font-weight: bold;">return</span> types.MethodType(<span style="color: #3a81c3; font-weight: bold;">self</span>, instance)


<span style="color: #ba2f59; font-weight: bold;">@Profiled</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">add</span>(x, y):
    <span style="color: #3a81c3; font-weight: bold;">return</span> x + y


add(4, 5)
<span style="color: #3a81c3; font-weight: bold;">print</span>(add.ncalls)
</pre>
</div>
</div>
</div>
<div id="outline-container-org57ccf52" class="outline-3">
<h3 id="org57ccf52"><span class="section-number-3">10.6</span> <code>inspect</code></h3>
<div class="outline-text-3" id="text-10-6">
<ul class="org-ul">
<li>signature</li>
<li>getargspec</li>
<li>Parameter</li>
</ul>
</div>
</div>

<div id="outline-container-org5fb2efe" class="outline-3">
<h3 id="org5fb2efe"><span class="section-number-3">10.7</span> Using Decorators to Patch Class Definitions</h3>
<div class="outline-text-3" id="text-10-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">patch</span>(cls):
    <span style="color: #715ab1;">orig_method</span> = cls.method

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">new_method</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">return</span> orig_method(<span style="color: #3a81c3; font-weight: bold;">self</span>)

    <span style="color: #715ab1;">cls.method</span> = new_method
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb081e41" class="outline-3">
<h3 id="orgb081e41"><span class="section-number-3">10.8</span> Enforcing an Argument Signature on *args and **kwargs</h3>
<div class="outline-text-3" id="text-10-8">
</div>
<div id="outline-container-orgae03556" class="outline-4">
<h4 id="orgae03556"><span class="section-number-4">10.8.1</span> Creating a Function Signature</h4>
<div class="outline-text-4" id="text-10-8-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> Signature, Parameter

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Make a signature for a func(x, y=42, *, z=None)</span>

<span style="color: #715ab1;">parms</span> = [
    Parameter(<span style="color: #2d9574;">'x'</span>, Parameter.POSITIONAL_OR_KEYWORD),
    Parameter(<span style="color: #2d9574;">'y'</span>, Parameter.POSITIONAL_OR_KEYWORD, default=42),
    Parameter(<span style="color: #2d9574;">'z'</span>, Parameter.KEYWORD_ONLY, default=<span style="color: #4e3163;">None</span>)
]
<span style="color: #715ab1;">sig</span> = Signature(parms)
<span style="color: #3a81c3; font-weight: bold;">print</span>(sig)

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">func</span>(*args, **kwargs):
    <span style="color: #715ab1;">bound_values</span> = sig.bind(*args, **kwargs)
</pre>
</div>
</div>
</div>

<div id="outline-container-org16992c1" class="outline-4">
<h4 id="org16992c1"><span class="section-number-4">10.8.2</span> <b>Enforcing Function Signatures</b></h4>
<div class="outline-text-4" id="text-10-8-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> Signature, Parameter
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">make_sig</span>(*names):
    <span style="color: #715ab1;">parms</span> = [Parameter(name, Parameter.POSITIONAL_OR_KEYWORD)
             <span style="color: #3a81c3; font-weight: bold;">for</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> names]
    <span style="color: #3a81c3; font-weight: bold;">return</span> Signature(parms)

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Structure</span>:
    <span style="color: #715ab1;">__signature__</span> = make_sig() <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">inspect.signature will lookup __signature__</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #715ab1;">bound_values</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.__signature__.bind(*args, **kwargs)
        <span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> bound_values.arguments.items():
            <span style="color: #3a81c3;">setattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, value)

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>(Structure):
    <span style="color: #715ab1;">__signature__</span> = make_sig(<span style="color: #2d9574;">'name'</span>, <span style="color: #2d9574;">'shares'</span>, <span style="color: #2d9574;">'price'</span>)
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #3a81c3;">super</span>().__init__(*args, **kwargs)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc8cc5f" class="outline-4">
<h4 id="orgbc8cc5f"><span class="section-number-4">10.8.3</span> Metaclass Approach</h4>
<div class="outline-text-4" id="text-10-8-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> Signature, Parameter


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">make_sig</span>(*names):
    <span style="color: #715ab1;">parms</span> = [
        Parameter(name, Parameter.POSITIONAL_OR_KEYWORD) <span style="color: #3a81c3; font-weight: bold;">for</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> names
    ]
    <span style="color: #3a81c3; font-weight: bold;">return</span> Signature(parms)


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">StructureMeta</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span>(cls, clsname, bases, clsdict):
        <span style="color: #715ab1;">clsdict</span>[<span style="color: #2d9574;">'__signature__'</span>] = make_sig(*clsdict.get(<span style="color: #2d9574;">'_fields'</span>, []))
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span>().__new__(cls, clsname, bases, clsdict)


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Structure</span>(metaclass=StructureMeta):
    <span style="color: #715ab1;">fields</span> = []

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #715ab1;">bound_values</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.__signature__.bind(*args, **kwargs)
        <span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> bound_values.arguments.items():
            <span style="color: #3a81c3;">setattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, value)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfe71197" class="outline-3">
<h3 id="orgfe71197"><span class="section-number-3">10.9</span> Parsing and Analyzing Python Source</h3>
<div class="outline-text-3" id="text-10-9">
<ul class="org-ul">
<li><code>eval('2 + 3*4 + x')</code></li>
</ul>
</div>
<div id="outline-container-orgacb56f1" class="outline-4">
<h4 id="orgacb56f1"><span class="section-number-4">10.9.1</span> <code>exec</code></h4>
<div class="outline-text-4" id="text-10-9-1">
<ul class="org-ul">
<li><code>exec('for i in range(10): print(i)')</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test1</span>():
    <span style="color: #715ab1;">x</span> = 0
    <span style="color: #3a81c3; font-weight: bold;">exec</span>(<span style="color: #2d9574;">'x += 1'</span>)
    <span style="color: #3a81c3; font-weight: bold;">print</span>(x) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 0</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test2</span>():
    <span style="color: #715ab1;">x</span> = 0
    <span style="color: #715ab1;">loc</span> = <span style="color: #3a81c3;">locals</span>()
    <span style="color: #3a81c3; font-weight: bold;">exec</span>(<span style="color: #2d9574;">'x += 1'</span>)
    <span style="color: #715ab1;">x</span> = loc[<span style="color: #2d9574;">'x'</span>]
    <span style="color: #3a81c3; font-weight: bold;">print</span>(x) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9851bd1" class="outline-4">
<h4 id="org9851bd1"><span class="section-number-4">10.9.2</span> <code>ast</code></h4>
<div class="outline-text-4" id="text-10-9-2">
<p>
compile Python source code into an abstract syntax tree(AST)
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> ast
<span style="color: #715ab1;">ex</span> = ast.parse(<span style="color: #2d9574;">'2 + 3*4 + x'</span>, mode=<span style="color: #2d9574;">'eval'</span>)
ast.dump(ex)
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">"Expression(body=BinOp(left=BinOp(left=Num(n=2), op=Add(), right=BinOp(left=Nu</span><span style="color: #6c4173; background-color: #ecf3ec;">m(n=3), op=Mult(), right=Num(n=4))), op=Add(), right=Name(id='x', ctx=Load())))"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org17a128e" class="outline-4">
<h4 id="org17a128e"><span class="section-number-4">10.9.3</span> Rewriting AST to Achieve Performance Improvement</h4>
<div class="outline-text-4" id="text-10-9-3">
<ul class="org-ul">
<li>see 9.24</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf45bed5" class="outline-3">
<h3 id="orgf45bed5"><span class="section-number-3">10.10</span> <code>dis</code></h3>
<div class="outline-text-3" id="text-10-10">
<ul class="org-ul">
<li><code>dis.dis</code></li>
<li>disassembled code: <code>some_func.__code__.co_code</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgc5af7a4" class="outline-3">
<h3 id="orgc5af7a4"><span class="section-number-3">10.11</span> Simple namedtuple</h3>
<div class="outline-text-3" id="text-10-11">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> operator

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">StructTupleMeta</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(cls, *args, **kwargs):
        <span style="color: #3a81c3;">super</span>().__init__(*args, **kwargs)
        <span style="color: #3a81c3; font-weight: bold;">for</span> n, name <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">enumerate</span>(cls._fields):
            <span style="color: #3a81c3;">setattr</span>(cls, name, <span style="color: #3a81c3;">property</span>(operator.itemgetter(n)))
            <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">After f = itemgetter(2), the call f(r) returns r[2]</span>

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">StructTuple</span>(<span style="color: #3a81c3;">tuple</span>, metaclass=StructTupleMeta):
    <span style="color: #715ab1;">_fields</span> = []

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span>(cls, *args):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">len</span>(args) != <span style="color: #3a81c3;">len</span>(cls._fields):
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">ValueError</span>(<span style="color: #2d9574;">'{} arguments required'</span>.<span style="color: #3a81c3;">format</span>(<span style="color: #3a81c3;">len</span>(cls._fields)))
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span>().__new__(cls, args)

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>(StructTuple):
    <span style="color: #715ab1;">_fields</span> = [<span style="color: #2d9574;">'name'</span>, <span style="color: #2d9574;">'shares'</span>, <span style="color: #2d9574;">'price'</span>]

<span style="color: #715ab1;">s</span> = Stock(<span style="color: #2d9574;">'ACME'</span>, 50, 91.1)
</pre>
</div>
</div>
</div>
<div id="outline-container-orge1af063" class="outline-3">
<h3 id="orge1af063"><span class="section-number-3">10.12</span> Multimethod 9.20</h3>
</div>
<div id="outline-container-org4fd9c3d" class="outline-3">
<h3 id="org4fd9c3d"><span class="section-number-3">10.13</span> Avoiding Repetitive Property</h3>
<div class="outline-text-3" id="text-10-13">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">typed_property</span>(name, expected_type):
    <span style="color: #715ab1;">storage_name</span> = <span style="color: #2d9574;">'_'</span> + name

    <span style="color: #ba2f59; font-weight: bold;">@property</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">prop</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">getattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, storage_name)

    <span style="color: #ba2f59; font-weight: bold;">@prop.setter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">prop</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, value):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span>(value, expected_type):
            <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">'{} must be a {}'</span>.<span style="color: #3a81c3;">format</span>(name, expected_type))
        <span style="color: #3a81c3;">setattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, storage_name, value)
    <span style="color: #3a81c3; font-weight: bold;">return</span> prop

<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> partial
<span style="color: #715ab1;">String</span> = partial(typed_property, expected_type=<span style="color: #3a81c3;">str</span>)
<span style="color: #715ab1;">Integer</span> = partial(typed_property, expected_type=<span style="color: #3a81c3;">int</span>)

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example use</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Person</span>:
    <span style="color: #715ab1;">name</span> = String(<span style="color: #2d9574;">'name'</span>)
    <span style="color: #715ab1;">age</span> = Integer(<span style="color: #2d9574;">'age'</span>)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, age):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
        <span style="color: #3a81c3; font-weight: bold;">self</span>.age = age
</pre>
</div>
</div>
</div>

<div id="outline-container-org72564a4" class="outline-3">
<h3 id="org72564a4"><span class="section-number-3">10.14</span> Defining Context Manager the Easy Way</h3>
<div class="outline-text-3" id="text-10-14">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> time
<span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> contextmanager

<span style="color: #ba2f59; font-weight: bold;">@contextmanager</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timethis</span>(label):
    <span style="color: #715ab1;">start</span> = time.time()
    <span style="color: #3a81c3; font-weight: bold;">try</span>:
        <span style="color: #3a81c3; font-weight: bold;">yield</span>
    <span style="color: #3a81c3; font-weight: bold;">finally</span>:
        <span style="color: #715ab1;">end</span> = time.time()
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'{}: {}'</span>.<span style="color: #3a81c3;">format</span>(label, end - start))

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example use</span>
<span style="color: #3a81c3; font-weight: bold;">with</span> timethis(<span style="color: #2d9574;">'counting'</span>):
    <span style="color: #715ab1;">n</span> = 10000000
    <span style="color: #3a81c3; font-weight: bold;">while</span> n &gt; 0:
        <span style="color: #715ab1;">n</span> -= 1
</pre>
</div>
<ul class="org-ul">
<li>all of the code prior to the yield executes as the <code>__enter__()</code> method of a context manager. All of the code after the <code>yield</code> executes as the <code>__exit__()</code> method</li>
<li>If there was an exception, it is <b>raised</b> at the <code>yield</code> statement.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org06a29b2" class="outline-2">
<h2 id="org06a29b2"><span class="section-number-2">11</span> Metaclass</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-orgcef72ab" class="outline-3">
<h3 id="orgcef72ab"><span class="section-number-3">11.1</span> Basic</h3>
<div class="outline-text-3" id="text-11-1">
<p>
When writing metaclasses, it is somewhat common to only define a <code>__new__()</code> or <code>__init__()</code> method, <b>but not both</b>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">MyMeta</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, clsname, bases, clsdict):
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">self is a class object</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">clsname is name of class being defined</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bases is tuple of base classes</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">clsdict is class dictionary</span>
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span>().__new__(<span style="color: #3a81c3; font-weight: bold;">self</span>, clsname, bases, clsdict)
</pre>
</div>
<p>
or
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">MyMeta</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(cls, clsname, bases, clsdict):
        <span style="color: #3a81c3;">super</span>().__init__(clsname, bases, clsdict)
</pre>
</div>
<dl class="org-dl">
<dt><code>__prepare__</code></dt><dd>is called first and used to <b>create the class namespace</b> prior to the body of any class definition being processed. Normally, this method simply returns a dictionary or other mapping object</dd>
<dt><code>__new__</code> </dt><dd>is invoked prior to class creation and is typically used when a metaclass wants to alter the class definition in some way</dd>
<dt><code>__init__</code></dt><dd>is invoked after a class has been created, and is useful if you want to write code that works with the fully formed class object.</dd>
</dl>
</div>
</div>

<div id="outline-container-orga2265b9" class="outline-3">
<h3 id="orga2265b9"><span class="section-number-3">11.2</span> NoInstances</h3>
<div class="outline-text-3" id="text-11-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">NoInstances</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span>(<span style="color: #2d9574;">"Can't instantiate directly"</span>)

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Spam</span>(metaclass=NoInstances):
    <span style="color: #ba2f59; font-weight: bold;">@staticmethod</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">grok</span>(x):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Spam.grok'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4398c50" class="outline-3">
<h3 id="org4398c50"><span class="section-number-3">11.3</span> Singleton</h3>
<div class="outline-text-3" id="text-11-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Singleton</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance = <span style="color: #4e3163;">None</span>
        <span style="color: #3a81c3;">super</span>().__init__(*args, **kwargs)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
            <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance = <span style="color: #3a81c3;">super</span>().__call__(*args, **kwargs)
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance
        <span style="color: #3a81c3; font-weight: bold;">else</span>:
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance
</pre>
</div>
</div>
</div>

<div id="outline-container-orga6b399b" class="outline-3">
<h3 id="orga6b399b"><span class="section-number-3">11.4</span> Cached Instances</h3>
<div class="outline-text-3" id="text-11-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> weakref

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Cached</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs):
        <span style="color: #3a81c3;">super</span>().__init__(*args, **kwargs)
        <span style="color: #3a81c3; font-weight: bold;">self</span>.__cache = weakref.WeakValueDictionary()

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *args):
        <span style="color: #3a81c3; font-weight: bold;">if</span> args <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__cache:
            <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__cache[args]
        <span style="color: #3a81c3; font-weight: bold;">else</span>:
            <span style="color: #715ab1;">obj</span> = <span style="color: #3a81c3;">super</span>().__call__(*args)
            <span style="color: #3a81c3; font-weight: bold;">self</span>.__cache[args] = obj
            <span style="color: #3a81c3; font-weight: bold;">return</span> obj
</pre>
</div>
</div>
</div>
<div id="outline-container-org119feb8" class="outline-3">
<h3 id="org119feb8"><span class="section-number-3">11.5</span> OrderedDict for Class Body</h3>
<div class="outline-text-3" id="text-11-5">
<p>
This method is invoked immediately at the start of a class definition with the class name and base classes. It must then return a mapping object to use when processing the class body.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Metaclass that uses an OrderedDict for class body</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">OrderedMeta</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span>(cls, clsname, bases, clsdict):
        <span style="color: #715ab1;">d</span> = <span style="color: #3a81c3;">dict</span>(clsdict)
        <span style="color: #715ab1;">order</span> = []
        <span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> clsdict.items():
            <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span>(value, Typed):
                <span style="color: #715ab1;">value._name</span> = name
                order.append(name)
        <span style="color: #715ab1;">d</span>[<span style="color: #2d9574;">'_order'</span>] = order
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">type</span>.__new__(cls, clsname, bases, d)

    <span style="color: #ba2f59; font-weight: bold;">@classmethod</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__prepare__</span>(cls, clsname, bases):
        <span style="color: #3a81c3; font-weight: bold;">return</span> OrderedDict()
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bc058f" class="outline-3">
<h3 id="org4bc058f"><span class="section-number-3">11.6</span> Optional Arguments on Class Definitions</h3>
<div class="outline-text-3" id="text-11-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Spam</span>(metaclass=MyMeta, debug=<span style="color: #4e3163;">True</span>, synchronize=<span style="color: #4e3163;">True</span>):
    ...
</pre>
</div>
<p>
To support such keyword arguments in a metaclass, make sure you define them on the
<code>__prepare__()</code>, <code>__new__()</code>, and <code>__init__()</code> methods using keyword-only arguments
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">MyMeta</span>(<span style="color: #3a81c3;">type</span>):
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Optional</span>
    <span style="color: #ba2f59; font-weight: bold;">@classmethod</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__prepare__</span>(cls, name, bases, *, debug=<span style="color: #4e3163;">False</span>, synchronize=<span style="color: #4e3163;">False</span>):
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Custom processing</span>
        ...
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span>().__prepare__(name, bases)

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Required</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span>(cls, name, bases, ns, *, debug=<span style="color: #4e3163;">False</span>, synchronize=<span style="color: #4e3163;">False</span>):
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Custom processing</span>
        ...
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span>().__new__(cls, name, bases, ns)

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Required</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, bases, ns, *, debug=<span style="color: #4e3163;">False</span>, synchronize=<span style="color: #4e3163;">False</span>):
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Custom processing</span>
        ...
        <span style="color: #3a81c3;">super</span>().__init__(name, bases, ns)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9294510" class="outline-2">
<h2 id="org9294510"><span class="section-number-2">12</span> Packages and Modules</h2>
<div class="outline-text-2" id="text-12">
</div>
<div id="outline-container-org420a400" class="outline-3">
<h3 id="org420a400"><span class="section-number-3">12.1</span> Lazy Import</h3>
<div class="outline-text-3" id="text-12-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">__init__.py</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">A</span>():
    <span style="color: #3a81c3; font-weight: bold;">from</span> .a <span style="color: #3a81c3; font-weight: bold;">import</span> A
    <span style="color: #3a81c3; font-weight: bold;">return</span> A()
</pre>
</div>
</div>
</div>

<div id="outline-container-orge312b8d" class="outline-3">
<h3 id="orge312b8d"><span class="section-number-3">12.2</span> Organize Add-on Packages into a Common Package</h3>
<div class="outline-text-3" id="text-12-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">foo-package/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">spam/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">blah.py</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bar-package/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">spam/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">grok.py</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> sys
sys.path.extend([<span style="color: #2d9574;">'foo-package'</span>, <span style="color: #2d9574;">'bar-package'</span>])
<span style="color: #3a81c3; font-weight: bold;">import</span> spam.blah
<span style="color: #3a81c3; font-weight: bold;">import</span> spam.grok
</pre>
</div>
</div>
</div>
<div id="outline-container-org4da0f80" class="outline-3">
<h3 id="org4da0f80"><span class="section-number-3">12.3</span> Read Data File</h3>
<div class="outline-text-3" id="text-12-3">
<ul class="org-ul">
<li><code>pkgutil.get_data</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgab2e38e" class="outline-3">
<h3 id="orgab2e38e"><span class="section-number-3">12.4</span> Import Hooks</h3>
<div class="outline-text-3" id="text-12-4">
<ul class="org-ul">
<li>See <code>10.11</code>, <code>10.12</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org3ed3cc5" class="outline-2">
<h2 id="org3ed3cc5"><span class="section-number-2">13</span> Network</h2>
<div class="outline-text-2" id="text-13">
</div>
<div id="outline-container-orga60d375" class="outline-3">
<h3 id="orga60d375"><span class="section-number-3">13.1</span> <code>socketserver</code></h3>
</div>
<div id="outline-container-org908c59a" class="outline-3">
<h3 id="org908c59a"><span class="section-number-3">13.2</span> CIDR network address</h3>
<div class="outline-text-3" id="text-13-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> ipaddress
<span style="color: #715ab1;">net</span> = ipaddress.ip_network(<span style="color: #2d9574;">'123.45.67.64/27'</span>)
<span style="color: #3a81c3;">list</span>(net)
net.num_addresses

<span style="color: #715ab1;">inet</span> = ipaddress.ip_interface(<span style="color: #2d9574;">'123.45.67.73/27'</span>)
inet.network
inet.ip
</pre>
</div>
</div>
</div>
<div id="outline-container-org5912494" class="outline-3">
<h3 id="org5912494"><span class="section-number-3">13.3</span> Simple WSGI</h3>
<div class="outline-text-3" id="text-13-3">
<p>
WSGI: Web Server Gateway Interface. Same code for different web framework.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">application</span>(environ, start_response):
    start_response(<span style="color: #2d9574;">'200 OK'</span>, [(<span style="color: #2d9574;">'Content-Type'</span>, <span style="color: #2d9574;">'text/html'</span>)])
    <span style="color: #3a81c3; font-weight: bold;">return</span> [b<span style="color: #2d9574;">'&lt;h1&gt;Hello, web!&lt;/h1&gt;'</span>]

<span style="color: #3a81c3; font-weight: bold;">from</span> wsgiref.simple_server <span style="color: #3a81c3; font-weight: bold;">import</span> make_server
<span style="color: #715ab1;">httpd</span> = make_server(<span style="color: #2d9574;">''</span>, 8000, application)
<span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Serving HTTP on port 8000...'</span>)
httpd.serve_forever()
</pre>
</div>
<ul class="org-ul">
<li>environ: http request info</li>
<li><code>start_response</code>: a function that must be called to initiate a response</li>
<li>return: response body</li>
</ul>
</div>

<div id="outline-container-org9a74787" class="outline-4">
<h4 id="org9a74787"><span class="section-number-4">13.3.1</span> PathDispatcher</h4>
<div class="outline-text-4" id="text-13-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> cgi


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">notfound_404</span>(environ, start_response):
    start_response(<span style="color: #2d9574;">'404 Not Found'</span>, [(<span style="color: #2d9574;">'Content-type'</span>, <span style="color: #2d9574;">'text/plain'</span>)])
    <span style="color: #3a81c3; font-weight: bold;">return</span> [b<span style="color: #2d9574;">'Not Found'</span>]


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">PathDispatcher</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.pathmap = {}

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, environ, start_response):
        <span style="color: #715ab1;">path</span> = environ[<span style="color: #2d9574;">'PATH_INFO'</span>]

        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">extracts supplied query parameters from the request and puts them into</span><span style="color: #6c4173; background-color: #ecf3ec;"> a dictionary-like object</span>
        <span style="color: #715ab1;">params</span> = cgi.FieldStorage(environ[<span style="color: #2d9574;">'wsgi.input'</span>], environ=environ)
        <span style="color: #715ab1;">method</span> = environ[<span style="color: #2d9574;">'REQUEST_METHOD'</span>].lower()
        <span style="color: #715ab1;">environ</span>[<span style="color: #2d9574;">'params'</span>] = {key: params.getvalue(key) <span style="color: #3a81c3; font-weight: bold;">for</span> key <span style="color: #3a81c3; font-weight: bold;">in</span> params}
        <span style="color: #715ab1;">handler</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.pathmap.get((method, path), notfound_404)
        <span style="color: #3a81c3; font-weight: bold;">return</span> handler(environ, start_response)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">register</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, method, path, function):
        <span style="color: #3a81c3; font-weight: bold;">self</span>.pathmap[method.lower(), path] = function
        <span style="color: #3a81c3; font-weight: bold;">return</span> function


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">hello</span>(environ, start_response):
    start_response(<span style="color: #2d9574;">'200 OK'</span>, [(<span style="color: #2d9574;">'Content-Type'</span>, <span style="color: #2d9574;">'text/html'</span>)])
    <span style="color: #3a81c3; font-weight: bold;">return</span> [b<span style="color: #2d9574;">'&lt;h1&gt;Hello, web!&lt;/h1&gt;'</span>]


<span style="color: #3a81c3; font-weight: bold;">from</span> wsgiref.simple_server <span style="color: #3a81c3; font-weight: bold;">import</span> make_server
<span style="color: #715ab1;">dispatcher</span> = PathDispatcher()
dispatcher.register(<span style="color: #2d9574;">'GET'</span>, <span style="color: #2d9574;">'/hello'</span>, hello)
<span style="color: #715ab1;">httpd</span> = make_server(<span style="color: #2d9574;">''</span>, 8080, dispatcher)
<span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Serving on port 8080...'</span>)
httpd.serve_forever()
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga15328a" class="outline-3">
<h3 id="orga15328a"><span class="section-number-3">13.4</span> XMLRPC</h3>
<div class="outline-text-3" id="text-13-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> xmlrpc.server <span style="color: #3a81c3; font-weight: bold;">import</span> SimpleXMLRPCServer

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">KeyValueServer</span>:
    <span style="color: #715ab1;">_rpc_methods_</span> = [<span style="color: #2d9574;">'get'</span>, <span style="color: #2d9574;">'set'</span>]
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, address):
        <span style="color: #3a81c3; font-weight: bold;">self</span>._data = {}
        <span style="color: #3a81c3; font-weight: bold;">self</span>._serv = SimpleXMLRPCServer(address, allow_none=<span style="color: #4e3163;">True</span>)
        <span style="color: #3a81c3; font-weight: bold;">for</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">self</span>._rpc_methods_:
            <span style="color: #3a81c3; font-weight: bold;">self</span>._serv.register_function(<span style="color: #3a81c3;">getattr</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name))

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">get</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name):
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>._data[name]

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">set</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, name, value):
        <span style="color: #3a81c3; font-weight: bold;">self</span>._data[name] = value

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">serve_forever</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">self</span>._serv.serve_forever()

<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">__name__</span> == <span style="color: #2d9574;">'__main__'</span>:
    <span style="color: #715ab1;">kvserv</span> = KeyValueServer((<span style="color: #2d9574;">''</span>, 15000))
    kvserv.serve_forever()
</pre>
</div>
<ul class="org-ul">
<li>client</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> xmlrpc.client <span style="color: #3a81c3; font-weight: bold;">import</span> ServerProxy
<span style="color: #715ab1;">s</span> = ServerProxy(<span style="color: #2d9574;">'http://localhost:15000'</span>, allow_none=<span style="color: #4e3163;">True</span>)
s.<span style="color: #3a81c3;">set</span>(<span style="color: #2d9574;">'foo'</span>, <span style="color: #2d9574;">'bar'</span>)
s.get(<span style="color: #2d9574;">'foo'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d5a899" class="outline-3">
<h3 id="org7d5a899"><span class="section-number-3">13.5</span> Communicating Between Interpreters</h3>
<div class="outline-text-3" id="text-13-5">
<ul class="org-ul">
<li><code>multiprocessing.connection</code>: support UNIX domain sockets</li>
</ul>
</div>
</div>

<div id="outline-container-orgdeaec83" class="outline-3">
<h3 id="orgdeaec83"><span class="section-number-3">13.6</span> Simple Auth</h3>
<div class="outline-text-3" id="text-13-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> hmac
<span style="color: #3a81c3; font-weight: bold;">import</span> os

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">client_authenticate</span>(connection, secret_key):
    <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">    Authenticate client to a remote service.</span>
<span style="color: #da8b55;">    connection represents a network connection.</span>
<span style="color: #da8b55;">    secret_key is a key known only to both client/server.</span>
<span style="color: #da8b55;">    '''</span>
    <span style="color: #715ab1;">message</span> = connection.recv(32)
    <span style="color: #3a81c3;">hash</span> = hmac.new(secret_key, message)
    <span style="color: #715ab1;">digest</span> = <span style="color: #3a81c3;">hash</span>.digest()
    connection.send(digest)


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">server_authenticate</span>(connection, secret_key):
    <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">    Request client authentication.</span>
<span style="color: #da8b55;">    '''</span>
    <span style="color: #715ab1;">message</span> = os.urandom(32)
    connection.send(message)
    <span style="color: #3a81c3;">hash</span> = hmac.new(secret_key, message)
    <span style="color: #715ab1;">digest</span> = <span style="color: #3a81c3;">hash</span>.digest()
    <span style="color: #715ab1;">response</span> = connection.recv(<span style="color: #3a81c3;">len</span>(digest))
    <span style="color: #3a81c3; font-weight: bold;">return</span> hmac.compare_digest(digest, response)
</pre>
</div>
</div>
</div>

<div id="outline-container-org60b134f" class="outline-3">
<h3 id="org60b134f"><span class="section-number-3">13.7</span> SSL Wrapper</h3>
<div class="outline-text-3" id="text-13-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> ssl
<span style="color: #715ab1;">KEYFILE</span> = <span style="color: #2d9574;">'server_key.pem'</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Private key of the server</span>
<span style="color: #715ab1;">CERTFILE</span> = <span style="color: #2d9574;">'server_cert.pem'</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Server certificate (given to client)</span>
<span style="color: #715ab1;">s_ssl</span> = ssl.wrap_socket(
    s, keyfile=KEYFILE, certfile=CERTFILE, server_side=<span style="color: #4e3163;">True</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org60d6ce6" class="outline-3">
<h3 id="org60d6ce6"><span class="section-number-3">13.8</span> select</h3>
<div class="outline-text-3" id="text-13-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> select

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">event_loop</span>(handlers):
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
        <span style="color: #715ab1;">wants_recv</span> = [h <span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> handlers <span style="color: #3a81c3; font-weight: bold;">if</span> h.wants_to_receive()]
        <span style="color: #715ab1;">wants_send</span> = [h <span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> handlers <span style="color: #3a81c3; font-weight: bold;">if</span> h.wants_to_send()]
        <span style="color: #715ab1;">can_recv</span>, <span style="color: #715ab1;">can_send</span>, <span style="color: #715ab1;">_</span> = select.select(wants_recv, wants_send, [])
        <span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> can_recv:
            h.handle_receive()
        <span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> can_send:
            h.handle_send()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6ad632" class="outline-3">
<h3 id="orgc6ad632"><span class="section-number-3">13.9</span> Sending Large Arrays</h3>
<div class="outline-text-3" id="text-13-9">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">zero copy with memoryview</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">send_from</span>(arr, dest):
    <span style="color: #715ab1;">view</span> = <span style="color: #3a81c3;">memoryview</span>(arr).cast(<span style="color: #2d9574;">'B'</span>)
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #3a81c3;">len</span>(view):
        <span style="color: #715ab1;">nsent</span> = dest.send(view)
        <span style="color: #715ab1;">view</span> = view[nsent:]


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">recv_into</span>(arr, source):
    <span style="color: #715ab1;">view</span> = <span style="color: #3a81c3;">memoryview</span>(arr).cast(<span style="color: #2d9574;">'B'</span>)
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #3a81c3;">len</span>(view):
        <span style="color: #715ab1;">nrecv</span> = source.recv_into(view)
        <span style="color: #715ab1;">view</span> = view[nrecv:]
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0803a4c" class="outline-2">
<h2 id="org0803a4c"><span class="section-number-2">14</span> Concurrency</h2>
<div class="outline-text-2" id="text-14">
</div>
<div id="outline-container-orgba1fdfe" class="outline-3">
<h3 id="orgba1fdfe"><span class="section-number-3">14.1</span> Threading</h3>
<div class="outline-text-3" id="text-14-1">
<ul class="org-ul">
<li><code>Thread</code> methods: <code>start</code>, <code>is_alive</code>, <code>join</code>, <code>terminate</code></li>
<li><code>Thread</code> interface: <code>run</code></li>
</ul>
</div>
<div id="outline-container-org1bf1922" class="outline-4">
<h4 id="org1bf1922"><span class="section-number-4">14.1.1</span> Daemonic Thread</h4>
<div class="outline-text-4" id="text-14-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">t</span> = Thread(target=countdown, args=(10,), daemon=<span style="color: #4e3163;">True</span>)
t.start()
</pre>
</div>
</div>
</div>

<div id="outline-container-org55d8170" class="outline-4">
<h4 id="org55d8170"><span class="section-number-4">14.1.2</span> Storing Thread-Specific State</h4>
<div class="outline-text-4" id="text-14-1-2">
<ul class="org-ul">
<li><code>threading.local()</code> : create a thread-local storage object</li>
</ul>
</div>
</div>

<div id="outline-container-orge52f060" class="outline-4">
<h4 id="orge52f060"><span class="section-number-4">14.1.3</span> Threading Pool</h4>
<div class="outline-text-4" id="text-14-1-3">
<ul class="org-ul">
<li><code>from concurrent.futures import ThreadPoolExecutor</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgd6b521d" class="outline-3">
<h3 id="orgd6b521d"><span class="section-number-3">14.2</span> Synchronization Primitives</h3>
<div class="outline-text-3" id="text-14-2">
</div>
<div id="outline-container-orgd18c09a" class="outline-4">
<h4 id="orgd18c09a"><span class="section-number-4">14.2.1</span> Event</h4>
<div class="outline-text-4" id="text-14-2-1">
<p>
Event instances are similar to a "sticky" flag that allows threads to wait for something to happan.
</p>
</div>
</div>

<div id="outline-container-orga578245" class="outline-4">
<h4 id="orga578245"><span class="section-number-4">14.2.2</span> Avoid Deadlock</h4>
<div class="outline-text-4" id="text-14-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> threading
<span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> contextmanager

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Thread-local state to stored information on locks already acquired</span>
<span style="color: #715ab1;">_local</span> = threading.local()


<span style="color: #ba2f59; font-weight: bold;">@contextmanager</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">acquire</span>(*locks):
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Sort locks by object identifier</span>
    <span style="color: #715ab1;">locks</span> = <span style="color: #3a81c3;">sorted</span>(locks, key=<span style="color: #3a81c3; font-weight: bold;">lambda</span> x: <span style="color: #3a81c3;">id</span>(x))

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Make sure lock order of previously acquired locks is not violated</span>
    <span style="color: #715ab1;">acquired</span> = <span style="color: #3a81c3;">getattr</span>(_local, <span style="color: #2d9574;">'acquired'</span>, [])
    <span style="color: #3a81c3; font-weight: bold;">if</span> acquired <span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #3a81c3;">max</span>(<span style="color: #3a81c3;">id</span>(lock) <span style="color: #3a81c3; font-weight: bold;">for</span> lock <span style="color: #3a81c3; font-weight: bold;">in</span> acquired) &gt;= <span style="color: #3a81c3;">id</span>(locks[0]):
        <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">RuntimeError</span>(<span style="color: #2d9574;">'Lock Order Violation'</span>)

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Acquire all of the locks</span>
    acquired.extend(locks)
    <span style="color: #715ab1;">_local.acquired</span> = acquired
    <span style="color: #3a81c3; font-weight: bold;">try</span>:
        <span style="color: #3a81c3; font-weight: bold;">for</span> lock <span style="color: #3a81c3; font-weight: bold;">in</span> locks:
            lock.acquire()
        <span style="color: #3a81c3; font-weight: bold;">yield</span>
    <span style="color: #3a81c3; font-weight: bold;">finally</span>:
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Release locks in reverse order of acquisition</span>
        <span style="color: #3a81c3; font-weight: bold;">for</span> lock <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">reversed</span>(locks):
            lock.release()
        <span style="color: #3a81c3; font-weight: bold;">del</span> acquired[-<span style="color: #3a81c3;">len</span>(locks):]


<span style="color: #3a81c3; font-weight: bold;">import</span> threading
<span style="color: #715ab1;">x_lock</span> = threading.Lock()
<span style="color: #715ab1;">y_lock</span> = threading.Lock()

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">thread_1</span>():
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
        <span style="color: #3a81c3; font-weight: bold;">with</span> acquire(x_lock, y_lock):
            <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Thread-1'</span>)

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">thread_2</span>():
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
        <span style="color: #3a81c3; font-weight: bold;">with</span> acquire(y_lock, x_lock):
            <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Thread-2'</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5ed0d48" class="outline-3">
<h3 id="org5ed0d48"><span class="section-number-3">14.3</span> Message Queue</h3>
<div class="outline-text-3" id="text-14-3">
<ul class="org-ul">
<li>ZeroMQ</li>
<li>Celery</li>
</ul>
</div>
<div id="outline-container-org757bf26" class="outline-4">
<h4 id="org757bf26"><span class="section-number-4">14.3.1</span> Actor Model</h4>
<div class="outline-text-4" id="text-14-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> queue <span style="color: #3a81c3; font-weight: bold;">import</span> Queue
<span style="color: #3a81c3; font-weight: bold;">from</span> threading <span style="color: #3a81c3; font-weight: bold;">import</span> Thread, Event


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Sentinel used for shutdown</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">ActorExit</span>(<span style="color: #ba2f59; font-weight: bold;">Exception</span>):
    <span style="color: #3a81c3; font-weight: bold;">pass</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Actor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">self</span>._mailbox = Queue()

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">send</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, msg):
        <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Send a message to the actor</span>
<span style="color: #da8b55;">        '''</span>
        <span style="color: #3a81c3; font-weight: bold;">self</span>._mailbox.put(msg)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">recv</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Receive an incoming message</span>
<span style="color: #da8b55;">        '''</span>
        <span style="color: #715ab1;">msg</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>._mailbox.get()
        <span style="color: #3a81c3; font-weight: bold;">if</span> msg <span style="color: #3a81c3; font-weight: bold;">is</span> ActorExit:
            <span style="color: #3a81c3; font-weight: bold;">raise</span> ActorExit()
        <span style="color: #3a81c3; font-weight: bold;">return</span> msg

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">close</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Close the actor, thus shutting it down</span>
<span style="color: #da8b55;">        '''</span>
        <span style="color: #3a81c3; font-weight: bold;">self</span>.send(ActorExit)

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">start</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Start concurrent execution</span>
<span style="color: #da8b55;">        '''</span>
        <span style="color: #3a81c3; font-weight: bold;">self</span>._terminated = Event()
        <span style="color: #715ab1;">t</span> = Thread(target=<span style="color: #3a81c3; font-weight: bold;">self</span>._bootstrap)
        <span style="color: #715ab1;">t.daemon</span> = <span style="color: #4e3163;">True</span>
        t.start()

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">_bootstrap</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">try</span>:
            <span style="color: #3a81c3; font-weight: bold;">self</span>.run()
        <span style="color: #3a81c3; font-weight: bold;">except</span> ActorExit:
            <span style="color: #3a81c3; font-weight: bold;">pass</span>
        <span style="color: #3a81c3; font-weight: bold;">finally</span>:
            <span style="color: #3a81c3; font-weight: bold;">self</span>._terminated.<span style="color: #3a81c3;">set</span>()

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">join</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">self</span>._terminated.wait()

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">run</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Run method to be implemented by the user</span>
<span style="color: #da8b55;">        '''</span>
        <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
            <span style="color: #715ab1;">msg</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.recv()
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org93a200a" class="outline-2">
<h2 id="org93a200a"><span class="section-number-2">15</span> System Utilities</h2>
<div class="outline-text-2" id="text-15">
<ul class="org-ul">
<li><code>getpass</code>: prompting for a password</li>
</ul>
</div>

<div id="outline-container-orgf0a07bd" class="outline-3">
<h3 id="orgf0a07bd"><span class="section-number-3">15.1</span> Subprocess</h3>
<div class="outline-text-3" id="text-15-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> subprocess
<span style="color: #715ab1;">out_bytes</span> = subprocess.check_output([<span style="color: #2d9574;">'netstat'</span>,<span style="color: #2d9574;">'-a'</span>])
<span style="color: #715ab1;">out_text</span> = out_bytes.decode(<span style="color: #2d9574;">'utf-8'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bf8c2b" class="outline-3">
<h3 id="org4bf8c2b"><span class="section-number-3">15.2</span> Performance Counter</h3>
<div class="outline-text-3" id="text-15-2">
<p>
use <code>time.perf_counter</code> for wall-time, <code>time.process_time</code> for CPU time
</p>
</div>
</div>
<div id="outline-container-org3901e96" class="outline-3">
<h3 id="org3901e96"><span class="section-number-3">15.3</span> CPU&amp;memory Limits</h3>
<div class="outline-text-3" id="text-15-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> signal
<span style="color: #3a81c3; font-weight: bold;">import</span> resource
<span style="color: #3a81c3; font-weight: bold;">import</span> os


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">time_exceeded</span>(signo, frame):
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">"Time's up!"</span>)
    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">SystemExit</span>(1)


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">set_max_runtime</span>(seconds):
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Install the signal handler and set a resource limit</span>
    <span style="color: #715ab1;">soft</span>, <span style="color: #715ab1;">hard</span> = resource.getrlimit(resource.RLIMIT_CPU)
    resource.setrlimit(resource.RLIMIT_CPU, (seconds, hard))
    signal.signal(signal.SIGXCPU, time_exceeded)

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">limit_memory</span>(maxsize):
    <span style="color: #715ab1;">soft</span>, <span style="color: #715ab1;">hard</span> = resource.getrlimit(resource.RLIMIT_AS)
    resource.setrlimit(resource.RLIMIT_AS, (maxsize, hard))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0cde600" class="outline-3">
<h3 id="org0cde600"><span class="section-number-3">15.4</span> webbrowser</h3>
<div class="outline-text-3" id="text-15-4">
<p>
<code>get</code>, <code>open</code>, <code>open_new</code>, <code>open_new_tab</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org77ad752" class="outline-2">
<h2 id="org77ad752"><span class="section-number-2">16</span> Testing</h2>
<div class="outline-text-2" id="text-16">
</div>
<div id="outline-container-org6c998dc" class="outline-3">
<h3 id="org6c998dc"><span class="section-number-3">16.1</span> Mock</h3>
<div class="outline-text-3" id="text-16-1">
<ul class="org-ul">
<li><code>unittest.mock.patch</code></li>
<li><code>@patch('somefunc')</code> or <code>with patch('somefunc') as mock</code></li>
<li>patch value: <code>with patch(__main__.x, 'patched_value')</code></li>
</ul>
</div>
</div>

<div id="outline-container-org74c65a1" class="outline-3">
<h3 id="org74c65a1"><span class="section-number-3">16.2</span> Assert Regex</h3>
<div class="outline-text-3" id="text-16-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.assertRaisesRegex(<span style="color: #ba2f59; font-weight: bold;">ValueError</span>, <span style="color: #2d9574;">'error*'</span>):
    ...
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf5fd734" class="outline-3">
<h3 id="orgf5fd734"><span class="section-number-3">16.3</span> Raise from another exception</h3>
<div class="outline-text-3" id="text-16-3">
<ul class="org-ul">
<li><code>raise ... from e</code></li>
</ul>
</div>
</div>

<div id="outline-container-org2204a0c" class="outline-3">
<h3 id="org2204a0c"><span class="section-number-3">16.4</span> Warnings</h3>
<div class="outline-text-3" id="text-16-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> warnings
warnings.warn(<span style="color: #2d9574;">'logfile argument deprecated'</span>, <span style="color: #ba2f59; font-weight: bold;">DeprecationWarning</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcea03c7" class="outline-2">
<h2 id="orgcea03c7"><span class="section-number-2">17</span> Debuging</h2>
<div class="outline-text-2" id="text-17">
<ul class="org-ul">
<li><code>python3 -i</code>: starts an shell as soon as a program terminates, then uses <code>pdb</code></li>
</ul>
</div>
<div id="outline-container-orgaaff7f0" class="outline-3">
<h3 id="orgaaff7f0"><span class="section-number-3">17.1</span> Traceback</h3>
<div class="outline-text-3" id="text-17-1">
<ul class="org-ul">
<li><code>traceback.print_exc(file=sys.stderr)</code></li>
<li><code>traceback.print_stack(file=sys.stderr)</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgc081568" class="outline-3">
<h3 id="orgc081568"><span class="section-number-3">17.2</span> Profiling</h3>
<div class="outline-text-3" id="text-17-2">
<p>
The first rule of optimization might be  to "not do it" the second rule is almost certainly "don't optimize the unimportant"
</p>
</div>
<div id="outline-container-org2e518b8" class="outline-4">
<h4 id="org2e518b8"><span class="section-number-4">17.2.1</span> Decorator Version</h4>
<div class="outline-text-4" id="text-17-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> time
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> wraps

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timethis</span>(func):
    <span style="color: #ba2f59; font-weight: bold;">@wraps</span>(func)
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">wrapper</span>(*args, **kwargs):
        <span style="color: #715ab1;">start</span> = time.perf_counter()
        <span style="color: #715ab1;">r</span> = func(*args, **kwargs)
        <span style="color: #715ab1;">end</span> = time.perf_counter()
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'{}.{} : {}'</span>.<span style="color: #3a81c3;">format</span>(func.__module__, func.<span style="color: #3a81c3;">__name__</span>, end - start))
        <span style="color: #3a81c3; font-weight: bold;">return</span> r
    <span style="color: #3a81c3; font-weight: bold;">return</span> wrapper
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2a2825" class="outline-4">
<h4 id="orgb2a2825"><span class="section-number-4">17.2.2</span> Contextmanager Version</h4>
<div class="outline-text-4" id="text-17-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> time
<span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> contextmanager

<span style="color: #ba2f59; font-weight: bold;">@contextmanager</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timeblock</span>(label):
    <span style="color: #715ab1;">start</span> = time.perf_counter()
    <span style="color: #3a81c3; font-weight: bold;">try</span>:
        <span style="color: #3a81c3; font-weight: bold;">yield</span>
    <span style="color: #3a81c3; font-weight: bold;">finally</span>:
        <span style="color: #715ab1;">end</span> = time.perf_counter()
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'{} : {}'</span>.<span style="color: #3a81c3;">format</span>(label, end - start))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9a519ea" class="outline-4">
<h4 id="org9a519ea"><span class="section-number-4">17.2.3</span> <code>time.process_time()</code></h4>
</div>
<div id="outline-container-org2dd851d" class="outline-4">
<h4 id="org2dd851d"><span class="section-number-4">17.2.4</span> Tools</h4>
<div class="outline-text-4" id="text-17-2-4">
<ul class="org-ul">
<li>pypy</li>
<li>Numba</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</body>
</html>

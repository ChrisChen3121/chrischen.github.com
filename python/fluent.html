<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<!-- 2020-06-09 Tue 16:23 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fluent Python</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ChrisChen" />
<meta name="keywords" content="python, fluent" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../styles/demo/css/demo.css"/>
<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Fluent Python</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3242153">1. Philosophy</a></li>
<li><a href="#org160ec73">2. Data Model</a>
<ul>
<li><a href="#orgaecde7d">2.1. Special Methods</a></li>
<li><a href="#org38f13d7">2.2. numeric types</a></li>
<li><a href="#orge686b84">2.3. Sequence categories</a></li>
<li><a href="#org6ab9d81">2.4. Collection Hierarchy</a></li>
</ul>
</li>
<li><a href="#org573d209">3. Metaprogramming</a>
<ul>
<li><a href="#org7d1738f">3.1. Monkey Patching</a></li>
</ul>
</li>
<li><a href="#orga218207">4. Iterator</a>
<ul>
<li><a href="#orgfae11aa">4.1. Compare with Iterable</a></li>
</ul>
</li>
<li><a href="#org29f468e">5. Functional Programming</a>
<ul>
<li><a href="#orgee672d5">5.1. Filtering</a></li>
<li><a href="#org28bbed2">5.2. Mapping</a></li>
<li><a href="#org662094c">5.3. Merging Multiple Inputs</a></li>
<li><a href="#org98433b2">5.4. Rearranging</a></li>
<li><a href="#orgcb45bd1">5.5. Reducing</a></li>
<li><a href="#orga82acbc">5.6. Others</a></li>
<li><a href="#orgb3c0548">5.7. <code>iter</code> Tricks</a></li>
</ul>
</li>
<li><a href="#org43e5db7">6. <code>else</code> keyword</a>
<ul>
<li><a href="#org6ce6d68">6.1. with <code>for/while</code></a></li>
<li><a href="#org186b7af">6.2. with <code>try</code></a></li>
</ul>
</li>
<li><a href="#org9f082d5">7. Context Manager</a>
<ul>
<li><a href="#orgdff5a00">7.1. Novel Usages</a></li>
<li><a href="#orgf6fff8f">7.2. <code>contextlib</code></a></li>
</ul>
</li>
<li><a href="#org25dd4f7">8. Coroutine</a>
<ul>
<li><a href="#org75877f8">8.1. states</a></li>
<li><a href="#org74fcf8b">8.2. Termination &amp; Exception</a></li>
<li><a href="#org08c2b5a">8.3. <code>yield from</code></a></li>
<li><a href="#orgef6a335">8.4. Discrete Event Simulations(DES)</a></li>
</ul>
</li>
<li><a href="#org706393a">9. Currency</a>
<ul>
<li><a href="#orgb8eea51">9.1. Threads &amp; Processes</a></li>
<li><a href="#orgd365900">9.2. Future</a></li>
<li><a href="#org9f3b446">9.3. asyncio + executor</a></li>
<li><a href="#org3c389e9">9.4. asyncio + aioXXX</a></li>
</ul>
</li>
<li><a href="#org1cf1f1e">10. asyncio</a>
<ul>
<li><a href="#org1354d07">10.1. <code>loop.create_future</code></a></li>
<li><a href="#org6cfe6f2">10.2. <code>loop.create_task</code> vs. <code>asyncio.ensure_future</code></a></li>
</ul>
</li>
<li><a href="#org1a31191">11. Doctest</a></li>
<li><a href="#org4643663">12. Utilities</a></li>
</ul>
</div>
</div>
<div id="outline-container-org3242153" class="outline-2">
<h2 id="org3242153"><span class="section-number-2">1</span> Philosophy</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>EAFP(python way)</li>
</ul>

<p>
Easier to ask for forgiveness than permission. This common Python coding style assumes the existence of valid keys
or attributes and catches exceptions if the assumption proves false. This clean and fast style is characterized by
the presence of many try and except statements. The technique contrasts with the LBYL style common to many other
languages such as C.
</p>

<ul class="org-ul">
<li>LBYL(contrast with EAFP)</li>
</ul>

<p>
Look before you leap. This coding style explicitly tests for pre-conditions before making calls or lookups. This
style contrasts with the EAFP approach and is characterized by the presence of many if statements. In a multi-threaded
environment, the LBYL approach can risk introducing a race condition between “the looking” and “the leaping”.
For example, the code, if key in mapping: return mapping[key] can fail if another thread removes key from mapping
after the test, but before the lookup. This issue can be solved with locks or by using the EAFP approach.
</p>
</div>
</div>

<div id="outline-container-org160ec73" class="outline-2">
<h2 id="org160ec73"><span class="section-number-2">2</span> Data Model</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgaecde7d" class="outline-3">
<h3 id="orgaecde7d"><span class="section-number-3">2.1</span> Special Methods</h3>
<div class="outline-text-3" id="text-2-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Category</th>
<th scope="col" class="org-left">Method names</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">String/bytes representation</td>
<td class="org-left"><code>__repr__</code> , <code>__str__</code> , <code>__format__</code> , <code>__bytes__</code></td>
</tr>

<tr>
<td class="org-left">Conversion to number</td>
<td class="org-left"><code>__abs__</code>, <code>__bool__</code>, <code>__complex__</code>, <code>__int__</code>, <code>__float__</code>, <code>__hash__</code>, <code>__index__</code></td>
</tr>

<tr>
<td class="org-left">Emulating collections</td>
<td class="org-left"><code>__len__</code>, <code>__getitem__</code>, <code>__setitem__</code>, <code>__delitem__</code>, <code>__contains__</code></td>
</tr>

<tr>
<td class="org-left">Iteration</td>
<td class="org-left"><code>__iter__</code>, <code>__reversed__</code>, <code>__next__</code></td>
</tr>

<tr>
<td class="org-left">Emulating callables</td>
<td class="org-left"><code>__call__</code></td>
</tr>

<tr>
<td class="org-left">Context management</td>
<td class="org-left"><code>__enter__</code>, <code>__exit__</code></td>
</tr>

<tr>
<td class="org-left">Instance creation and destruction</td>
<td class="org-left"><code>__new__</code>, <code>__init__</code>, <code>__del__</code></td>
</tr>

<tr>
<td class="org-left">Attribute management</td>
<td class="org-left"><code>__getattr__</code>, <code>__getattribute__</code>, <code>__setattr__</code>, <code>__delattr__</code>, <code>__dir__</code></td>
</tr>

<tr>
<td class="org-left">Attribute descriptors</td>
<td class="org-left"><code>__get__</code>, <code>__set__</code>, <code>__delete__</code></td>
</tr>

<tr>
<td class="org-left">Class services</td>
<td class="org-left"><code>__prepare__</code>, <code>__instancecheck__</code>, <code>__subclasscheck__</code></td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li>operators</li>
</ul>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Category</th>
<th scope="col" class="org-left">Method names</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Unary numeric operators</td>
<td class="org-left"><code>__neg__ -</code>, <code>__pos__ +</code>, <code>__abs__ abs()</code></td>
</tr>

<tr>
<td class="org-left">Rich comparison operators</td>
<td class="org-left"><code>__lt__ &gt;</code>, <code>__le__ &lt;=</code>, <code>__eq__ ==</code>, <code>__ne__ !=</code>, <code>__gt__ &gt;</code>, <code>__ge__ &gt;=</code></td>
</tr>

<tr>
<td class="org-left">Arithmetic operators</td>
<td class="org-left"><code>__add__ +</code>, <code>__sub__ -</code>, <code>__mul__ =, =__truediv__ /</code>, <code>__floordiv__ //</code>, <code>__mod__\n%</code>, <code>__divmod__ divmod()</code>, <code>__pow__ ** or pow()</code>, <code>__round__ round()</code></td>
</tr>

<tr>
<td class="org-left">Reversed arithmetic operators</td>
<td class="org-left"><code>__radd__</code>, <code>__rsub__</code>, <code>__rmul__</code>, <code>__rtruediv__</code>, <code>__rfloordiv__</code>, <code>__rmod__</code>, <code>__rdivmod__</code>, <code>__rpow__</code></td>
</tr>

<tr>
<td class="org-left">Augmented assignment  arithmetic operators</td>
<td class="org-left"><code>__iadd__</code>, <code>__isub__</code>, <code>__imul__</code>, <code>__itruediv__</code>, <code>__ifloordiv__</code>, <code>__imod__</code>, <code>__ipow__</code></td>
</tr>

<tr>
<td class="org-left">Bitwise operators</td>
<td class="org-left"><code>__invert__ ~</code>, <code>__lshift__ &lt;&lt;</code>, <code>__rshift__ &gt;&gt;</code>, <code>__and__ &amp;</code>, <code>__or__</code>, <code>__xor__ ^</code></td>
</tr>

<tr>
<td class="org-left">Reversed bitwise operators</td>
<td class="org-left"><code>__rlshift__</code>, <code>__rrshift__</code>, <code>__rand__</code>, <code>__rxor__</code>, <code>__ror__</code></td>
</tr>

<tr>
<td class="org-left">Augmented assignment bitwise operators</td>
<td class="org-left"><code>__ilshift__</code>, <code>__irshift__</code>, <code>__iand__</code>, <code>__ixor__</code>, <code>__ior__</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org38f13d7" class="outline-3">
<h3 id="org38f13d7"><span class="section-number-3">2.2</span> numeric types</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>decimal.Decimal</li>
<li>fractions.Fraction</li>
</ul>
</div>
</div>

<div id="outline-container-orge686b84" class="outline-3">
<h3 id="orge686b84"><span class="section-number-3">2.3</span> Sequence categories</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orge316291" class="outline-4">
<h4 id="orge316291"><span class="section-number-4">2.3.1</span> Flat(hold one type)</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
str, bytes, bytearray, memoryview, array.array
</p>
<ul class="org-ul">
<li>If the <code>list</code> will only contain numbers, <code>array.array</code> is more efficient than a <code>list</code></li>
</ul>
</div>
</div>

<div id="outline-container-orga961b0e" class="outline-4">
<h4 id="orga961b0e"><span class="section-number-4">2.3.2</span> Mutable</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
list, bytearray, array.array, collections.deque, memoryview
</p>
</div>
</div>

<div id="outline-container-org0a461d9" class="outline-4">
<h4 id="org0a461d9"><span class="section-number-4">2.3.3</span> Immutable</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
tuple, str, bytes
</p>
</div>
</div>

<div id="outline-container-orgf5755a7" class="outline-4">
<h4 id="orgf5755a7"><span class="section-number-4">2.3.4</span> abcs</h4>
<div class="outline-text-4" id="text-2-3-4">
<p>
<a href="https://docs.python.org/3/library/collections.abc.html">Collections Abstract Base Classes</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org6ab9d81" class="outline-3">
<h3 id="org6ab9d81"><span class="section-number-3">2.4</span> Collection Hierarchy</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-plantuml"><span style="color: #ba2f59; font-weight: bold;">interface</span> Container {
{method} __contains__
}

<span style="color: #ba2f59; font-weight: bold;">interface</span> Iterable {
{method} __iter__
}

<span style="color: #ba2f59; font-weight: bold;">interface</span> Sized {
{method} __len__
}

<span style="color: #ba2f59; font-weight: bold;">interface</span> Sequence {
{method} __getitem__
{method} __reversed__
{method} index
{method} count
}
Container <span style="color: #3a81c3; font-weight: bold;">&lt;|--</span> Sequence
Iterable <span style="color: #3a81c3; font-weight: bold;">&lt;|--</span> Sequence
Sized <span style="color: #3a81c3; font-weight: bold;">&lt;|--</span> Sequence
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org573d209" class="outline-2">
<h2 id="org573d209"><span class="section-number-2">3</span> Metaprogramming</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org7d1738f" class="outline-3">
<h3 id="org7d1738f"><span class="section-number-3">3.1</span> Monkey Patching</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Changing a class or module at runtime, without touching the source code.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">some_obj.__getitem__</span> = some_get_function(some_class, position)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga218207" class="outline-2">
<h2 id="orga218207"><span class="section-number-2">4</span> Iterator</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgfae11aa" class="outline-3">
<h3 id="orgfae11aa"><span class="section-number-3">4.1</span> Compare with Iterable</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>Iterator is a Iterable, they both have a <code>__iter__</code> method</li>
<li>In addition, Iterator has a <code>__next__</code> method</li>
<li>Iterator <code>__iter__</code> often return itself</li>
<li>To support multiple traversals of aggregate objects</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org29f468e" class="outline-2">
<h2 id="org29f468e"><span class="section-number-2">5</span> Functional Programming</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgee672d5" class="outline-3">
<h3 id="orgee672d5"><span class="section-number-3">5.1</span> Filtering</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>built-in <code>filter</code></li>
<li><code>filterfalse(predicate, it)</code></li>
<li><code>islice(it, stop) or islice(it, start, stop, step=1)</code></li>
<li><code>compress(it, selector_it)</code>: Consumes two iterables in parallel; yields items from it whenever the corresponding item in selector_it is truthy</li>
<li><code>dropwhile(predicate, it)</code>: Consumes it skipping items while predicate computes truthy, then yields every remaining item</li>
<li><code>takewhile(predicate, it)</code>: Yields items while predicate computes truthy, then stops</li>
</ul>
</div>
</div>

<div id="outline-container-org28bbed2" class="outline-3">
<h3 id="org28bbed2"><span class="section-number-3">5.2</span> Mapping</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>built-in <code>enumerate(iterable, start=0)</code></li>
<li>built-in <code>map(func, it1, [it2, …, itN])</code></li>
<li><code>accumulate(it, [func])</code>: Yields accumulated sums(default); if func is provided, yields the result of applying it to the first pair of items, then to the first result and next item</li>
<li><code>starmap(func, it)</code>: Applies func to each item of it, yielding the result; the input iterable should yield iterable items iit, and func is applied as func(*iit)</li>
</ul>
</div>
</div>

<div id="outline-container-org662094c" class="outline-3">
<h3 id="org662094c"><span class="section-number-3">5.3</span> Merging Multiple Inputs</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li><code>chain(it1, …, itN)</code></li>
<li><code>chain.from_iterable(it)</code>: Yield all items from each <b>iterable</b> produced by it, one after the other, seamlessly</li>
<li><code>product(it1, …, itN, repeat=1)</code>: <b>Cartesian product</b>; yields N-tuples made by combining items from each input iterable like nested for loops could produce; <b>repeat</b> allows the input iterables to be consumed more than once.</li>
<li>(built-in) <code>zip(it1, …, itN)~</code>: Silently stopping when the first iterable is exhausted</li>
<li><code>zip_longest(it1, …, itN, fillvalue=None)</code>: Stopping only when the last iterable is exhausted, filling the blanks with the fillvalue</li>
</ul>
</div>
</div>

<div id="outline-container-org98433b2" class="outline-3">
<h3 id="org98433b2"><span class="section-number-3">5.4</span> Rearranging</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li><code>groupby(it, key=None)</code>: Yields 2-tuples of the form (key, group)</li>
<li><code>reversed(seq)</code></li>
<li><code>tee(it, n=2)</code>: Yields multiple generators from a single input iterable</li>
</ul>
</div>
</div>

<div id="outline-container-orgcb45bd1" class="outline-3">
<h3 id="orgcb45bd1"><span class="section-number-3">5.5</span> Reducing</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li>built-in <code>all(it)</code></li>
<li>built-in <code>any(it)</code></li>
<li>built-in <code>max(it, [key=,] [default=])</code></li>
<li>built-in <code>min(it, [key=,] [default=])</code></li>
<li>functools <code>reduce(func, it, [initial])</code></li>
<li>built-in <code>sum(it, start=0)</code></li>
</ul>
</div>
</div>

<div id="outline-container-orga82acbc" class="outline-3">
<h3 id="orga82acbc"><span class="section-number-3">5.6</span> Others</h3>
<div class="outline-text-3" id="text-5-6">
<ul class="org-ul">
<li><p>
<code>count(start=0, step=1)</code>: indefinitely
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">aritprog_gen</span>(begin, step, end=<span style="color: #4e3163;">None</span>):
    <span style="color: #715ab1;">first</span> = <span style="color: #3a81c3;">type</span>(begin + step)(begin)
    <span style="color: #715ab1;">ap_gen</span> = itertools.count(first, step)
    <span style="color: #3a81c3; font-weight: bold;">if</span> end <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #4e3163;">None</span>:
        <span style="color: #715ab1;">ap_gen</span> = itertools.takewhile(<span style="color: #3a81c3; font-weight: bold;">lambda</span> n: n &lt; end, ap_gen)
    <span style="color: #3a81c3; font-weight: bold;">return</span> ap_gen
</pre>
</div></li>
<li><code>cycle(it)</code>: indefinitely</li>
<li><code>repeat(item, [times])</code>: Yield the given item repeadedly, indefinetly unless a number of times is given</li>
<li><code>combinations(it, out_len)</code>: Yield combinations of <i>out_len</i> items from the items yielded by it</li>
<li><code>combinations_with_replacement(it, out_len)</code></li>
<li><code>permutations(it, out_len=None)</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgb3c0548" class="outline-3">
<h3 id="orgb3c0548"><span class="section-number-3">5.7</span> <code>iter</code> Tricks</h3>
<div class="outline-text-3" id="text-5-7">
<p>
<code>iter(callable, sentinel)</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">d6</span>():
    <span style="color: #3a81c3; font-weight: bold;">return</span> randint(1, 6)
<span style="color: #715ab1;">d6_iter</span> = <span style="color: #3a81c3;">iter</span>(d6, 1)  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the second argument is a sentinel</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">another useful example</span>
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span>(<span style="color: #2d9574;">'mydata.txt'</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> fp:
    <span style="color: #3a81c3; font-weight: bold;">for</span> line <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">iter</span>(fp.readline, <span style="color: #2d9574;">''</span>):
        process_line(line)
</pre>
</div>
<ul class="org-ul">
<li>when a sentinel returned by the callable, causes the iterator to <b>raise StopIteration</b> instead of <b>yielding the sentinel</b>.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org43e5db7" class="outline-2">
<h2 id="org43e5db7"><span class="section-number-2">6</span> <code>else</code> keyword</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org6ce6d68" class="outline-3">
<h3 id="org6ce6d68"><span class="section-number-3">6.1</span> with <code>for/while</code></h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">for</span> item <span style="color: #3a81c3; font-weight: bold;">in</span> my_list:
    <span style="color: #3a81c3; font-weight: bold;">if</span> item.flavor == <span style="color: #2d9574;">'banana'</span>:
        <span style="color: #3a81c3; font-weight: bold;">break</span>
<span style="color: #3a81c3; font-weight: bold;">else</span>:
    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">ValueError</span>(<span style="color: #2d9574;">'No banana flavor found!'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org186b7af" class="outline-3">
<h3 id="org186b7af"><span class="section-number-3">6.2</span> with <code>try</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">try</span>:
    dangerous_call()
<span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">OSError</span>:
    log(<span style="color: #2d9574;">'OSError...'</span>)
<span style="color: #3a81c3; font-weight: bold;">else</span>:
    after_call()
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9f082d5" class="outline-2">
<h2 id="org9f082d5"><span class="section-number-2">7</span> Context Manager</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>The <code>with</code> statement was designed to simplify the try/finally pattern</li>
<li><code>__enter__()~</code></li>
<li><code>__exit__(self, exc_type, exc_value, traceback)</code>: arguments are None, None, None if all went well

<ul class="org-ul">
<li>return True to tell the interpreter that the exception was handled.</li>
<li>If returns None or anything but True, any exception raised in the with block will be propagated.</li>
</ul></li>
</ul>
</div>

<div id="outline-container-orgdff5a00" class="outline-3">
<h3 id="orgdff5a00"><span class="section-number-3">7.1</span> Novel Usages</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>Managing transactions in the sqlite3 module</li>
<li>Holding locks, conditions, and semaphores in threading code(RAII)</li>
<li>Setting up environments for arithmetic operations with Decimal objects</li>
<li>Applying temporary patches to objects for testing</li>
</ul>
</div>
</div>

<div id="outline-container-orgf6fff8f" class="outline-3">
<h3 id="orgf6fff8f"><span class="section-number-3">7.2</span> <code>contextlib</code></h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-org8b3d4b5" class="outline-4">
<h4 id="org8b3d4b5"><span class="section-number-4">7.2.1</span> <code>@contextmanager</code> &amp; <code>@asynccontextmanager</code></h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
A decorator that lets you build a context manager from a simple generator function, instead of creating a class and implementing the protocol.
</p>
<ul class="org-ul">
<li>Use <code>yield</code> to produce whatever you want the <code>__enter__</code> method to return</li>
<li>Essentially the contextlib.contextmanager decorator wraps the function in a class that implements the <code>__enter__</code> and <code>__exit__</code> methods.</li>
<li><code>__enter__</code>

<ol class="org-ol">
<li>Invokes the generator function and holds on to the generator object—let's call it <i>gen</i>.</li>
<li>Calls <code>next(gen)</code> to make it run to the <code>yield</code> keyword.</li>
<li>Returns the value yielded by <code>next(gen)</code>, so it can be bound to a target variable in the <code>with/as</code> form.</li>
</ol></li>

<li><code>__exit__</code>

<ol class="org-ol">
<li>Checks an exception was passed as <code>exc_type</code>; if so, <code>gen.throw(exception)</code> is invoked, causing the exception to be raised in the yield line inside the generator function body.</li>
<li>Otherwise, <code>next(gen)</code> is called, resuming the execution of the generator function body after the yield.</li>
</ol></li>
</ul>
</div>

<ul class="org-ul">
<li><a id="orgde14afc"></a>Tips<br />
<div class="outline-text-5" id="text-orgde14afc">
<ul class="org-ul">
<li>The <code>__exit__</code> method provided by the decorator assumes any exception sent into the generator is handled and should be suppressed.</li>
</ul>
<p>
You must explicitly re-raise an exception in the decorated function if you don't want <code>@contextmanager</code> to suppress it.
</p>

<ul class="org-ul">
<li>Having a <code>try/finally</code> (or a <code>with</code> block) around the <code>yield</code> is an <b>unavoidable</b> price of using <code>@contextmanager</code>,</li>
</ul>
<p>
because you never know what the users of your context manager are going to do inside their with block.
</p>
</div>
</li>

<li><a id="orgbc74f16"></a>Example<br />
<div class="outline-text-5" id="text-orgbc74f16">
<p>
A context manager for rewriting files in place
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> csv

<span style="color: #3a81c3; font-weight: bold;">with</span> inplace(csvfilename, <span style="color: #2d9574;">'r'</span>, newline=<span style="color: #2d9574;">''</span>) <span style="color: #3a81c3; font-weight: bold;">as</span> (infh, outfh):
    <span style="color: #715ab1;">reader</span> = csv.reader(infh)
    <span style="color: #715ab1;">writer</span> = csv.writer(outfh)

    <span style="color: #3a81c3; font-weight: bold;">for</span> row <span style="color: #3a81c3; font-weight: bold;">in</span> reader:
        <span style="color: #715ab1;">row</span> += [<span style="color: #2d9574;">'new'</span>, <span style="color: #2d9574;">'columns'</span>]
        writer.writerow(row)
</pre>
</div>
</div>
</li>
</ul>
</div>


<div id="outline-container-org7109aac" class="outline-4">
<h4 id="org7109aac"><span class="section-number-4">7.2.2</span> closing</h4>
<div class="outline-text-4" id="text-7-2-2">
<p>
A function to build context managers out of objects that provide a close() method but don’t implement the <code>__enter__/__exit__</code> protocol.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> closing
<span style="color: #3a81c3; font-weight: bold;">from</span> urllib.request <span style="color: #3a81c3; font-weight: bold;">import</span> urlopen

<span style="color: #3a81c3; font-weight: bold;">with</span> closing(urlopen(<span style="color: #2d9574;">'http://www.python.org'</span>)) <span style="color: #3a81c3; font-weight: bold;">as</span> page:
    <span style="color: #3a81c3; font-weight: bold;">for</span> line <span style="color: #3a81c3; font-weight: bold;">in</span> page:
        <span style="color: #3a81c3; font-weight: bold;">print</span>(line)
</pre>
</div>
</div>
</div>

<div id="outline-container-org8848129" class="outline-4">
<h4 id="org8848129"><span class="section-number-4">7.2.3</span> suppress</h4>
<div class="outline-text-4" id="text-7-2-3">
<p>
A context manager to temporarily ignore specified exceptions.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> suppress

<span style="color: #3a81c3; font-weight: bold;">with</span> suppress(<span style="color: #ba2f59; font-weight: bold;">FileNotFoundError</span>):
    os.remove(<span style="color: #2d9574;">'somefile.tmp'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb0abdb" class="outline-4">
<h4 id="orgfb0abdb"><span class="section-number-4">7.2.4</span> ContextDecorator</h4>
<div class="outline-text-4" id="text-7-2-4">
<p>
A base class for defining class-based context managers that can also be used as function decorators, running the entire function within a managed context.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> ContextDecorator
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">mycontext</span>(ContextDecorator):
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__enter__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Starting'</span>)
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__exit__</span>(<span style="color: #3a81c3; font-weight: bold;">self</span>, *exc):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'Finishing'</span>)
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">False</span>

<span style="color: #ba2f59; font-weight: bold;">@mycontext</span>()
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">function</span>():
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'The bit in the middle'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7dbda82" class="outline-4">
<h4 id="org7dbda82"><span class="section-number-4">7.2.5</span> ExitStack &amp; AsyncExitStack</h4>
<div class="outline-text-4" id="text-7-2-5">
<p>
A context manager that lets you enter a variable number of context managers. When the with block ends, ExitStack calls the stacked context managers' <code>__exit__</code> methods in LIFO order
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">with</span> ExitStack() <span style="color: #3a81c3; font-weight: bold;">as</span> stack:
    <span style="color: #715ab1;">files</span> = [stack.enter_context(<span style="color: #3a81c3;">open</span>(fname)) <span style="color: #3a81c3; font-weight: bold;">for</span> fname <span style="color: #3a81c3; font-weight: bold;">in</span> filenames]
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">All opened files will automatically be closed at the end of</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the with statement, even if attempts to open files later</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">in the list raise an exception</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org80ba2d2" class="outline-4">
<h4 id="org80ba2d2"><span class="section-number-4">7.2.6</span> others</h4>
<div class="outline-text-4" id="text-7-2-6">
<ul class="org-ul">
<li><code>redirect_stdout</code>, <code>redirect_stderr</code></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org25dd4f7" class="outline-2">
<h2 id="org25dd4f7"><span class="section-number-2">8</span> Coroutine</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>Generators produce data for iteration</li>
<li>Coroutines are consumers of data</li>
<li>To keep your brain from exploding, you don't mix the two concepts together</li>
<li>Coroutines are not related to iteration</li>
<li><code>.send()</code> allows two-way data exchange between the client code and the generator in contrast with <code>.__next__()</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">simple_coroutine</span>():
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'-&gt; coroutine started'</span>)
    <span style="color: #715ab1;">x</span> = <span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">received by send(x)</span>
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'-&gt; coroutine received:'</span>, x)

<span style="color: #715ab1;">coro</span> = simple_coroutine() <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">GEN_CREATED</span>
<span style="color: #3a81c3;">next</span>(coro) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">equivalent to coro.send(None). GEN_CREATED-&gt;GEN_RUNNING-&gt;GEN_SUSPEN</span><span style="color: #6c4173; background-color: #ecf3ec;">DED</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">-&gt; coroutine started</span>
coro.send(42) <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">GEN_SUSPENDED-&gt;GEN_RUNNING-&gt;GEN_CLOSED</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">-&gt; coroutine received: 42</span>
</pre>
</div>
<ul class="org-ul">
<li><code>next(coro)</code> is often describe as "priming" the coroutine(advancing it to the first <code>yield</code>, the EXPR after first yield will be executed)</li>
</ul>
</div>


<div id="outline-container-org75877f8" class="outline-3">
<h3 id="org75877f8"><span class="section-number-3">8.1</span> states</h3>
<div class="outline-text-3" id="text-8-1">
<p>
use <code>inspect.getgeneratorstate()</code> to get state
</p>
<ul class="org-ul">
<li>GEN_CREATED: Waiting to start execution</li>
<li>GEN_RUNNING: Currently being executed by the interpreter</li>
<li>GEN_SUSPENDED: Currently suspended at a yield expression</li>
<li>GEN_CLOSED</li>
</ul>
</div>
</div>

<div id="outline-container-org74fcf8b" class="outline-3">
<h3 id="org74fcf8b"><span class="section-number-3">8.2</span> Termination &amp; Exception</h3>
<div class="outline-text-3" id="text-8-2">
<p>
The coroutine will only terminate when the caller calls <code>.close()</code> on it, or when it's garbage collected
</p>
</div>

<div id="outline-container-org25035d8" class="outline-4">
<h4 id="org25035d8"><span class="section-number-4">8.2.1</span> Return Value</h4>
<div class="outline-text-4" id="text-8-2-1">
<p>
The value attribute of the StopIteration carries the value returned
</p>
</div>
</div>

<div id="outline-container-org4ad4ab7" class="outline-4">
<h4 id="org4ad4ab7"><span class="section-number-4">8.2.2</span> Exception From Generator</h4>
<div class="outline-text-4" id="text-8-2-2">
<p>
An exception within a coroutine propagates to the caller that triggered it.
</p>
</div>
</div>

<div id="outline-container-org1ba7d62" class="outline-4">
<h4 id="org1ba7d62"><span class="section-number-4">8.2.3</span> Terminate Generator</h4>
<div class="outline-text-4" id="text-8-2-3">
<ul class="org-ul">
<li><code>throw(exc_type[, exc_value[, traceback]])</code>: Causes the yield expression where the generator was paused to raise the exception given.</li>
<li><code>close</code>: Causes the yield expression where the generator was paused to raise a <code>GeneratorExit</code> exception.</li>
</ul>
</div>
</div>

<div id="outline-container-orgb0869be" class="outline-4">
<h4 id="orgb0869be"><span class="section-number-4">8.2.4</span> Sentinel Values</h4>
<div class="outline-text-4" id="text-8-2-4">
<p>
<code>None</code>, <code>...</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org08c2b5a" class="outline-3">
<h3 id="org08c2b5a"><span class="section-number-3">8.3</span> <code>yield from</code></h3>
<div class="outline-text-3" id="text-8-3">
<p>
The main feature of <code>yield from</code> is to open a <code>bidirectional</code> channel from the outermost caller to the innermost subgenerator.
</p>
<ul class="org-ul">
<li>Any values that the subgenerator yields are passed directly to the caller of the delegating generator</li>
<li>Any values sent to the delegating generator using <code>send()</code> are passed directly to the subgenerator.</li>
<li>return expr in a generator (or subgenerator) causes <code>StopIteration(expr)</code> to be raised upon exit from the generator.</li>
<li>The value of the <code>yield from</code> expression is the first argument to the <code>StopIteration</code> exception raised by the subgenerator when it terminates.</li>
<li>Exception Handling: Exceptions other than <code>GeneratorExit</code> thrown into the delegating generator are passed to the <code>throw()</code> method of</li>
</ul>
<p>
the subgenerator. If the call raises <code>StopIteration</code>, the delegating generator is resumed. Any other exception is propagated to the
delegating generator.
</p>
<ul class="org-ul">
<li>If a <code>GeneratorExit</code> exception is thrown into the delegating generator, or the <code>close()</code> method of the delegating generator is called,</li>
</ul>
<p>
then the <code>close()</code> method of the subgenerator is called if it has one. If this call results in an exception, it is propagated to the
delegating generator. Otherwise, <code>GeneratorExit</code> is raised in the delegating generator.
</p>
</div>

<div id="outline-container-orga785ce4" class="outline-4">
<h4 id="orga785ce4"><span class="section-number-4">8.3.1</span> Pseudocode</h4>
<div class="outline-text-4" id="text-8-3-1">
</div>
<ul class="org-ul">
<li><a id="orgf1d6490"></a>Simple Version<br />
<div class="outline-text-5" id="text-orgf1d6490">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">_i</span> = <span style="color: #3a81c3;">iter</span>(EXPR)
<span style="color: #3a81c3; font-weight: bold;">try</span>:
    <span style="color: #715ab1;">_y</span> = <span style="color: #3a81c3;">next</span>(_i)
<span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span> <span style="color: #3a81c3; font-weight: bold;">as</span> _e:
    <span style="color: #715ab1;">_r</span> = _e.value <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the RESULT in the simplest case</span>
<span style="color: #3a81c3; font-weight: bold;">else</span>: <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">channel between the caller and the subgenerator</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> 1:
        <span style="color: #715ab1;">_s</span> = <span style="color: #3a81c3; font-weight: bold;">yield</span> _y
        <span style="color: #3a81c3; font-weight: bold;">try</span>:
            <span style="color: #715ab1;">_y</span> = _i.send(_s)
        <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span> <span style="color: #3a81c3; font-weight: bold;">as</span> _e:
            <span style="color: #715ab1;">_r</span> = _e.value
            <span style="color: #3a81c3; font-weight: bold;">break</span>
<span style="color: #715ab1;">RESULT</span> = _r
</pre>
</div>
<ul class="org-ul">
<li>_i(iterator): The subgenerator</li>
<li>_y(yielded): A value yielded from the subgenerator</li>
<li>_r(result): The eventual result</li>
<li>_s(sent): A value sent by the caller to the delegating generator, which is forwarded to the subgenerator</li>
<li>_e(exception): An exception</li>
</ul>
</div>
</li>

<li><a id="org307a174"></a>Complete Version<br />
<div class="outline-text-5" id="text-org307a174">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">_i</span> = <span style="color: #3a81c3;">iter</span>(EXPR)
<span style="color: #3a81c3; font-weight: bold;">try</span>:
    <span style="color: #715ab1;">_y</span> = <span style="color: #3a81c3;">next</span>(_i)
<span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span> <span style="color: #3a81c3; font-weight: bold;">as</span> _e:
    <span style="color: #715ab1;">_r</span> = _e.value
<span style="color: #3a81c3; font-weight: bold;">else</span>:
    <span style="color: #3a81c3; font-weight: bold;">while</span> 1:
        <span style="color: #3a81c3; font-weight: bold;">try</span>:
            <span style="color: #715ab1;">_s</span> = <span style="color: #3a81c3; font-weight: bold;">yield</span> _y
        <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">GeneratorExit</span> <span style="color: #3a81c3; font-weight: bold;">as</span> _e:
            <span style="color: #3a81c3; font-weight: bold;">try</span>:
                <span style="color: #715ab1;">_m</span> = _i.close
            <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">AttributeError</span>:
                <span style="color: #3a81c3; font-weight: bold;">pass</span>
            <span style="color: #3a81c3; font-weight: bold;">else</span>:
                _m()
            <span style="color: #3a81c3; font-weight: bold;">raise</span> _e
        <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">BaseException</span> <span style="color: #3a81c3; font-weight: bold;">as</span> _e:
            <span style="color: #715ab1;">_x</span> = sys.exc_info()
            <span style="color: #3a81c3; font-weight: bold;">try</span>:
                <span style="color: #715ab1;">_m</span> = _i.throw
            <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">AttributeError</span>:
                <span style="color: #3a81c3; font-weight: bold;">raise</span> _e
            <span style="color: #3a81c3; font-weight: bold;">else</span>:
                <span style="color: #3a81c3; font-weight: bold;">try</span>:
                    <span style="color: #715ab1;">_y</span> = _m(*_x)
                <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span> <span style="color: #3a81c3; font-weight: bold;">as</span> _e:
                    <span style="color: #715ab1;">_r</span> = _e.value
                    <span style="color: #3a81c3; font-weight: bold;">break</span>
        <span style="color: #3a81c3; font-weight: bold;">else</span>:
            <span style="color: #3a81c3; font-weight: bold;">try</span>:
                <span style="color: #3a81c3; font-weight: bold;">if</span> _s <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
                    <span style="color: #715ab1;">_y</span> = <span style="color: #3a81c3;">next</span>(_i)
                <span style="color: #3a81c3; font-weight: bold;">else</span>:
                    <span style="color: #715ab1;">_y</span> = _i.send(_s)
            <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span> <span style="color: #3a81c3; font-weight: bold;">as</span> _e:
                <span style="color: #715ab1;">_r</span> = _e.value
                <span style="color: #3a81c3; font-weight: bold;">break</span>

<span style="color: #715ab1;">RESULT</span> = _r
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgef6a335" class="outline-3">
<h3 id="orgef6a335"><span class="section-number-3">8.4</span> Discrete Event Simulations(DES)</h3>
<div class="outline-text-3" id="text-8-4">
<p>
<code>SimPy</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org706393a" class="outline-2">
<h2 id="org706393a"><span class="section-number-2">9</span> Currency</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgb8eea51" class="outline-3">
<h3 id="orgb8eea51"><span class="section-number-3">9.1</span> Threads &amp; Processes</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-org2b0e6d9" class="outline-4">
<h4 id="org2b0e6d9"><span class="section-number-4">9.1.1</span> Executor</h4>
<div class="outline-text-4" id="text-9-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> concurrent <span style="color: #3a81c3; font-weight: bold;">import</span> futures
<span style="color: #3a81c3; font-weight: bold;">with</span> futures.ThreadPoolExecutor(4) <span style="color: #3a81c3; font-weight: bold;">as</span> executor:
    <span style="color: #715ab1;">results</span> = executor.<span style="color: #3a81c3;">map</span>(process_one, <span style="color: #3a81c3;">sorted</span>(args))
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">map: 1. create and schedule futures 2. retrive the future.result() one by </span><span style="color: #6c4173; background-color: #ecf3ec;">one</span>
    <span style="color: #3a81c3; font-weight: bold;">print</span>(results)

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">equivalent to</span>
<span style="color: #3a81c3; font-weight: bold;">with</span> futures.ThreadPoolExecutor(4) <span style="color: #3a81c3; font-weight: bold;">as</span> executor:
    <span style="color: #715ab1;">fs</span> = [executor.submit(process_one, arg) <span style="color: #3a81c3; font-weight: bold;">for</span> arg <span style="color: #3a81c3; font-weight: bold;">in</span> args]
    <span style="color: #3a81c3; font-weight: bold;">for</span> completed_future <span style="color: #3a81c3; font-weight: bold;">in</span> futures.as_completed(fs):
        <span style="color: #3a81c3; font-weight: bold;">print</span>(completed_future.result())
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">len</span>(<span style="color: #3a81c3;">list</span>(results))
</pre>
</div>
<ul class="org-ul">
<li>The combination of <code>executor.submit</code> and <code>futures.as_completed</code> is more flexible than <code>executor.map</code></li>
</ul>
<p>
because you can submit different callables and arguments, while <code>executor.map</code> is designed to run the
same callable on the different arguments.
</p>
<ul class="org-ul">
<li>Future is hashable</li>
</ul>
</div>
</div>

<div id="outline-container-org70c19f5" class="outline-4">
<h4 id="org70c19f5"><span class="section-number-4">9.1.2</span> GIL</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
Restricts only one thread at a time to execute Python bytecodes. However, all standard library functions
that perform blocking I/O release the GIL when waiting for a result from the OS.
</p>
<ul class="org-ul">
<li>All standard library functions that perform blocking I/O release the GIL when waiting for a result from the OS. I/O bound program can benefit from using threads.</li>
</ul>
</div>
</div>

<div id="outline-container-org70f47db" class="outline-4">
<h4 id="org70f47db"><span class="section-number-4">9.1.3</span> Spin Example</h4>
<div class="outline-text-4" id="text-9-1-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Signal</span>:
    <span style="color: #715ab1;">go</span> = <span style="color: #4e3163;">True</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">spin</span>(msg, signal):
    <span style="color: #715ab1;">write</span>, <span style="color: #715ab1;">flush</span> = sys.stdout.write, sys.stdout.flush
    <span style="color: #3a81c3; font-weight: bold;">for</span> char <span style="color: #3a81c3; font-weight: bold;">in</span> itertools.cycle(<span style="color: #2d9574;">'|/-\\'</span>):
        <span style="color: #715ab1;">status</span> = char + <span style="color: #2d9574;">' '</span> + msg
        write(status)
        flush()
        write(<span style="color: #2d9574;">'\x08'</span> * <span style="color: #3a81c3;">len</span>(status))
        time.sleep(.1)
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> signal.go:
            <span style="color: #3a81c3; font-weight: bold;">break</span>
    write(<span style="color: #2d9574;">' '</span> * <span style="color: #3a81c3;">len</span>(status) + <span style="color: #2d9574;">'\x08'</span> * <span style="color: #3a81c3;">len</span>(status))

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">supervisor</span>():
    <span style="color: #715ab1;">signal</span> = Signal()
    <span style="color: #715ab1;">spinner</span> = threading.Thread(target=spin,
                               args=(<span style="color: #2d9574;">'thinking!'</span>, signal))
    <span style="color: #3a81c3; font-weight: bold;">print</span>(<span style="color: #2d9574;">'spinner object:'</span>, spinner)
    spinner.start()
    <span style="color: #715ab1;">result</span> = slow_function()
    <span style="color: #715ab1;">signal.go</span> = <span style="color: #4e3163;">False</span>
    spinner.join()
    <span style="color: #3a81c3; font-weight: bold;">return</span> result
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd365900" class="outline-3">
<h3 id="orgd365900"><span class="section-number-3">9.2</span> Future</h3>
<div class="outline-text-3" id="text-9-2">
<p>
Interface: cancel, cancelled, running, done, result(timeout=None), exception(timeout=None), add_done_callback(fn)
</p>
</div>
</div>

<div id="outline-container-org9f3b446" class="outline-3">
<h3 id="org9f3b446"><span class="section-number-3">9.3</span> asyncio + executor</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> asyncio
<span style="color: #3a81c3; font-weight: bold;">import</span> time
<span style="color: #3a81c3; font-weight: bold;">from</span> concurrent.futures <span style="color: #3a81c3; font-weight: bold;">import</span> ThreadPoolExecutor <span style="color: #3a81c3; font-weight: bold;">as</span> Executor


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">blocking_task</span>():
    time.sleep(2)
    <span style="color: #3a81c3; font-weight: bold;">return</span> 42


<span style="color: #3a81c3; font-weight: bold;">async def</span> <span style="color: #6c3163; font-weight: bold;">run_tasks</span>(executor):
    <span style="color: #715ab1;">loop</span> = asyncio.get_event_loop()
    <span style="color: #715ab1;">blocking_tasks</span> = []
    <span style="color: #3a81c3; font-weight: bold;">for</span> _ <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">range</span>(40):
        <span style="color: #715ab1;">task</span> = loop.run_in_executor(executor, blocking_task)
        blocking_tasks.append(task)
    <span style="color: #715ab1;">completed</span>, <span style="color: #715ab1;">pending</span> = <span style="color: #3a81c3; font-weight: bold;">await</span> asyncio.wait(blocking_tasks)
    <span style="color: #3a81c3; font-weight: bold;">for</span> t <span style="color: #3a81c3; font-weight: bold;">in</span> completed:
        <span style="color: #3a81c3; font-weight: bold;">print</span>(t.result())


<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">__name__</span> == <span style="color: #2d9574;">'__main__'</span>:
    <span style="color: #715ab1;">event_loop</span> = asyncio.get_event_loop()
    <span style="color: #715ab1;">executor</span> = Executor(20)
    event_loop.run_until_complete(run_tasks(executor))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c389e9" class="outline-3">
<h3 id="org3c389e9"><span class="section-number-3">9.4</span> asyncio + aioXXX</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> asyncio


<span style="color: #3a81c3; font-weight: bold;">async def</span> <span style="color: #6c3163; font-weight: bold;">aiotask</span>():
    <span style="color: #3a81c3; font-weight: bold;">await</span> asyncio.sleep(2)
    <span style="color: #3a81c3; font-weight: bold;">return</span> 42

<span style="color: #715ab1;">event_loop</span> = asyncio.get_event_loop()
<span style="color: #715ab1;">tasks</span> = [aiotask() <span style="color: #3a81c3; font-weight: bold;">for</span> _ <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">range</span>(1000)]
<span style="color: #715ab1;">results</span> = event_loop.run_until_complete(asyncio.gather(*tasks))
<span style="color: #3a81c3; font-weight: bold;">for</span> result <span style="color: #3a81c3; font-weight: bold;">in</span> results:
    <span style="color: #3a81c3; font-weight: bold;">print</span>(result)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1cf1f1e" class="outline-2">
<h2 id="org1cf1f1e"><span class="section-number-2">10</span> asyncio</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-org1354d07" class="outline-3">
<h3 id="org1354d07"><span class="section-number-3">10.1</span> <code>loop.create_future</code></h3>
<div class="outline-text-3" id="text-10-1">
<p>
This is a preferred way to create futures in asyncio, as event loop implementations
can provide alternative implementations of the Future class
</p>
</div>
</div>

<div id="outline-container-org6cfe6f2" class="outline-3">
<h3 id="org6cfe6f2"><span class="section-number-3">10.2</span> <code>loop.create_task</code> vs. <code>asyncio.ensure_future</code></h3>
<div class="outline-text-3" id="text-10-2">
<p>
Always use <code>loop.create_task</code> to schedule coroutines, however use <code>asyncio.ensure_future</code> for
other awaitable objects(like Futures, Tasks)
</p>
</div>
</div>
</div>

<div id="outline-container-org1a31191" class="outline-2">
<h2 id="org1a31191"><span class="section-number-2">11</span> Doctest</h2>
</div>
<div id="outline-container-org4643663" class="outline-2">
<h2 id="org4643663"><span class="section-number-2">12</span> Utilities</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li><code>math.hypot</code>: Return the Euclidean distance, <code>sqrt(x*x + y*y)</code></li>
<li><code>b, a = a, b</code>: swap values without using a temporary variable</li>
<li><b>Vaurien</b>: chaos monkey, the Chaos TCP Proxy</li>
<li>requests resp: <code>resp.raise_for_status()</code></li>
<li><code>httpbin</code></li>
<li><code>SimPy</code>: DES simulation</li>
<li><code>lelo</code></li>
<li><code>python-parallelize</code></li>
<li><code>Celery</code></li>
</ul>
</div>
</div>
</div>
</body>
</html>
